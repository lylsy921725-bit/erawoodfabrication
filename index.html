<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EraWood 模块化建筑作品集</title>
  <style>
    :root {
      color-scheme: dark;
      --bg-main: #04060f;
      --surface: #0b1220;
      --surface-elevated: #111b2e;
      --surface-muted: #1a2742;
      --accent: #38bdf8;
      --accent-2: #22d3ee;
      --text-primary: #e2e8f0;
      --text-secondary: #cbd5f5;
      --text-muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.28);
      --shadow: 0 18px 40px rgba(3, 6, 12, 0.7);
      font-size: clamp(14px, 1.1vw, 16px);
    }

    

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "PingFang SC", "Microsoft Yahei", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-primary);
      background: radial-gradient(circle at 20% -10%, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(34, 211, 238, 0.18), transparent 50%), var(--bg-main);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(4, 7, 15, 0.9);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 8px 28px rgba(4, 7, 15, 0.6);
    }

    .nav-bar {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0.9rem clamp(1rem, 5vw, 2.4rem);
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-primary);
    }

    .logo-mark {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      color: white;
      font-size: 1.05rem;
      box-shadow: 0 18px 32px rgba(34, 211, 238, 0.22);
      overflow: hidden;
    }

    .logo-mark img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      mix-blend-mode: normal;
      transform-origin: center;
      transition: transform 120ms ease;
    }

    nav {
      display: flex;
      gap: clamp(0.75rem, 3vw, 1.75rem);
      margin-left: auto;
      font-size: 0.95rem;
      letter-spacing: 0.05em;
    }

    nav a {
      position: relative;
      padding: 0.25rem 0;
    }

    nav a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -0.2rem;
      height: 2px;
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      transform-origin: right;
      transform: scaleX(0);
      transition: transform 180ms ease;
    }

    nav a:hover::after,
    nav a:focus-visible::after {
      transform-origin: left;
      transform: scaleX(1);
    }

    main {
      max-width: 1120px;
      margin: 0 auto;
      padding: clamp(3rem, 8vw, 5rem) clamp(1rem, 5vw, 2.4rem);
      display: grid;
      gap: clamp(4rem, 9vw, 6rem);
    }

    section {
      display: grid;
      gap: clamp(1.5rem, 4vw, 3rem);
    }

    h1, h2, h3, h4 {
      margin: 0;
      letter-spacing: 0.02em;
    }

    h1 {
      font-size: clamp(2.4rem, 5vw, 3.6rem);
      line-height: 1.2;
    }

    h2 {
      font-size: clamp(2rem, 4vw, 2.75rem);
    }

    h3 {
      font-size: clamp(1.35rem, 2.5vw, 1.75rem);
    }

    p {
      margin: 0;
      color: var(--text-secondary);
      line-height: 1.7;
      font-size: 1rem;
    }

    .hero {
      display: grid;
      gap: clamp(1.5rem, 5vw, 2.5rem);
    }

    .hero-intro {
      font-size: clamp(1.05rem, 1.4vw, 1.25rem);
      color: var(--text-secondary);
      max-width: 44ch;
    }

    .hero-meta {
      display: flex;
      gap: clamp(1rem, 3vw, 2rem);
      flex-wrap: wrap;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.18);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.88rem;
      letter-spacing: 0.05em;
    }

    .section-head {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      max-width: 60ch;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
    }

    .filter-button {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      padding: 0.45rem 1.05rem;
      border-radius: 999px;
      font-size: 0.88rem;
      letter-spacing: 0.04em;
      transition: all 180ms ease;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(56, 189, 248, 0);
    }

    .filter-button:hover {
      border-color: rgba(56, 189, 248, 0.45);
      color: var(--text-primary);
      box-shadow: inset 0 0 0 1px rgba(56, 189, 248, 0.35);
    }

    .filter-button.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: 0 12px 32px rgba(34, 211, 238, 0.3);
      border-color: transparent;
    }

    .gallery-grid {
      display: grid;
      gap: clamp(1.2rem, 3vw, 1.8rem);
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .project-card {
      position: relative;
      background: var(--surface-elevated);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-rows: auto 1fr;
      transition: transform 180ms ease, box-shadow 220ms ease;
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.14);
    }

    .project-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 22px 52px rgba(3, 7, 18, 0.6);
    }

    .card-image {
      position: relative;
      aspect-ratio: 16 / 10;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, rgba(148, 163, 184, 0.18), transparent 65%),
        linear-gradient(140deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.65));
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform-origin: center;
      transition: transform 120ms ease;
    }

    .card-body {
      padding: 1.4rem 1.6rem 1.8rem;
      display: grid;
      gap: 1rem;
    }

    .card-header {
      display: grid;
      gap: 0.55rem;
    }

    .card-header h3 {
      font-size: clamp(1.35rem, 2.5vw, 1.75rem);
    }

    .card-description {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.65;
    }

    .spec-list {
      display: grid;
      gap: 0.45rem;
      padding: 0.9rem 1rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.16);
    }

    .spec-item {
      display: flex;
      gap: 0.45rem;
      font-size: 0.88rem;
      color: var(--text-secondary);
    }

    .spec-label {
      color: var(--text-muted);
      letter-spacing: 0.05em;
      flex: 0 0 5.6em;
    }

    .spec-value {
      flex: 1;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .gallery-empty {
      padding: 2.4rem;
      background: rgba(148, 163, 184, 0.08);
      border-radius: 18px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.95rem;
      border: 1px dashed rgba(148, 163, 184, 0.28);
    }

    .contact-card {
      display: grid;
      gap: 1.2rem;
      padding: clamp(1.8rem, 4vw, 2.4rem);
      background: var(--surface-elevated);
      border-radius: 22px;
      box-shadow: var(--shadow);
      max-width: 580px;
      border: 1px solid rgba(148, 163, 184, 0.16);
    }

    .contact-grid {
      display: grid;
      gap: clamp(1rem, 3vw, 1.6rem);
    }

    .contact-item {
      display: grid;
      gap: 0.35rem;
    }

    .contact-item span {
      color: var(--text-muted);
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    footer {
      margin-top: clamp(3rem, 6vw, 4rem);
      background: var(--surface-muted);
      color: rgba(226, 232, 240, 0.9);
      padding: clamp(2rem, 5vw, 3rem) clamp(1rem, 5vw, 2.4rem);
      text-align: center;
      font-size: 0.9rem;
      letter-spacing: 0.04em;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* Admin area */
    #admin {
      background: var(--surface);
      padding: clamp(2rem, 5vw, 2.8rem);
      border-radius: 24px;
      box-shadow: var(--shadow);
      display: grid;
      gap: clamp(1.6rem, 4vw, 2.4rem);
      border: 1px solid rgba(148, 163, 184, 0.14);
    }

    .admin-login {
      display: grid;
      gap: 1rem;
      max-width: 420px;
    }

    label {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.06em;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.6rem 0.85rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      font: inherit;
      background: rgba(15, 23, 42, 0.55);
      color: var(--text-primary);
      transition: border 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }

    input:focus-visible,
    textarea:focus-visible,
    select:focus-visible {
      outline: none;
      border-color: rgba(56, 189, 248, 0.8);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.28);
      background: rgba(15, 23, 42, 0.9);
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.65rem 1.3rem;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      letter-spacing: 0.05em;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      transition: transform 150ms ease, box-shadow 200ms ease;
      box-shadow: 0 12px 28px rgba(34, 211, 238, 0.3);
    }

    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .button.secondary {
      background: rgba(15, 23, 42, 0.45);
      color: var(--text-primary);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: none;
    }

    .button.secondary:hover {
      background: rgba(34, 211, 238, 0.15);
      border-color: rgba(56, 189, 248, 0.6);
    }

    .button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(91, 140, 133, 0.28);
    }

    .admin-panels {
      display: grid;
      gap: clamp(1.6rem, 3vw, 2rem);
    }

    .admin-card {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 20px;
      padding: clamp(1.4rem, 3vw, 1.8rem);
      display: grid;
      gap: clamp(1.2rem, 3vw, 1.6rem);
      background: rgba(17, 27, 46, 0.85);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .data-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .admin-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .category-list,
    .work-list,
    .image-list {
      display: grid;
      gap: 1rem;
    }

    .category-item,
    .work-item,
    .image-item {
      background: var(--surface);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      display: grid;
      gap: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.24);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }

    .category-header,
    .work-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .image-thumb {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
    }

    .image-preview-frame {
      flex-shrink: 0;
      width: 120px;
      aspect-ratio: 16 / 10;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: linear-gradient(140deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.65));
      display: grid;
      place-items: center;
    }

    .image-preview-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center;
      transition: transform 120ms ease;
    }

    .image-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .brand-preview {
      display: grid;
      gap: 0.85rem;
      padding: 1rem 1.2rem;
      border-radius: 16px;
      background: rgba(8, 13, 24, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .brand-preview .logo {
      font-size: 1.1rem;
    }

    .brand-preview .logo.upload-target {
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.24);
      border-radius: 12px;
      padding: 0.6rem 0.9rem;
      transition: border-color 0.18s ease, background 0.18s ease;
    }

    .brand-preview .logo.upload-target[data-state='empty'] {
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.38);
    }

    .brand-preview .logo.upload-target:hover {
      border-color: rgba(56, 189, 248, 0.6);
      background: rgba(15, 23, 42, 0.55);
    }

    .brand-preview .logo.upload-target:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 3px;
    }

    .brand-preview-intro {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .brand-preview .logo-mark {
      width: 48px;
      height: 48px;
      font-size: 1.2rem;
    }

    .brand-upload {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .image-transform {
      display: grid;
      gap: 0.65rem;
      background: rgba(8, 13, 24, 0.52);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 12px;
      padding: 0.75rem 0.9rem;
    }

    .image-transform.disabled {
      opacity: 0.5;
    }

    .transform-control {
      display: grid;
      gap: 0.4rem;
    }

    .transform-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .transform-value {
      color: var(--text-secondary);
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .transform-actions {
      display: flex;
      justify-content: flex-end;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.7rem;
      font-size: 0.78rem;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      color: var(--text-primary);
      letter-spacing: 0.06em;
    }

    .inline-form {
      display: grid;
      gap: 0.6rem;
    }

    .work-meta-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    details summary {
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.05em;
      color: var(--accent);
      margin-bottom: 0.6rem;
    }

    .logout-bar {
      display: flex;
      justify-content: flex-end;
    }

    .divider {
      height: 1px;
      background: rgba(148, 163, 184, 0.24);
      width: 100%;
    }

    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: clamp(1rem, 6vw, 4rem);
      z-index: 30;
    }

    .lightbox.open {
      display: flex;
    }

    .lightbox-content {
      background: rgba(15, 23, 42, 0.94);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      max-width: min(960px, 92vw);
      width: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto;
      overflow: hidden;
      box-shadow: 0 24px 56px rgba(15, 23, 42, 0.45);
      color: var(--text-primary);
    }

    .lightbox-media {
      position: relative;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(14, 116, 144, 0.6));
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 16 / 9;
      overflow: hidden;
    }

    .lightbox-media img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform-origin: center;
    }

    .lightbox-meta {
      padding: 1rem 1.3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      background: rgba(15, 23, 42, 0.86);
      border-top: 1px solid rgba(148, 163, 184, 0.22);
    }

    .lightbox-controls {
      display: flex;
      gap: 0.75rem;
    }

    .control {
      border: none;
      background: rgba(56, 189, 248, 0.18);
      color: var(--text-primary);
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.08em;
      transition: background 150ms ease, box-shadow 180ms ease;
    }

    .control:hover {
      background: rgba(56, 189, 248, 0.3);
      box-shadow: 0 10px 20px rgba(34, 211, 238, 0.25);
    }

    .control:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      padding: 0;
      display: grid;
      place-items: center;
      border-radius: 999px;
      background: rgba(8, 13, 24, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.28);
      font-size: 1.2rem;
      backdrop-filter: blur(8px);
      z-index: 1;
    }

    .lightbox-nav:hover {
      background: rgba(56, 189, 248, 0.28);
      box-shadow: 0 12px 28px rgba(34, 211, 238, 0.28);
    }

    .lightbox-nav:disabled {
      opacity: 0.35;
      background: rgba(8, 13, 24, 0.55);
      box-shadow: none;
    }

    #lightbox-prev {
      left: 1.25rem;
    }

    #lightbox-next {
      right: 1.25rem;
    }

    .close-btn {
      border: none;
      background: transparent;
      font-size: 1.6rem;
      line-height: 1;
      cursor: pointer;
      color: rgba(226, 232, 240, 0.6);
      transition: color 160ms ease;
    }

    .close-btn:hover {
      color: rgba(226, 232, 240, 0.9);
    }

    @media (max-width: 720px) {
      nav {
        display: none;
      }

      header {
        position: static;
      }

      .nav-bar {
        justify-content: center;
      }

      .hero-meta {
        flex-direction: column;
        align-items: flex-start;
      }

      .card-body {
        padding: 1.1rem 1.2rem 1.4rem;
      }
    }

      body {
        background: var(--brand-light);
        color: var(--brand-dark);
      }

      header {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(148, 163, 184, 0.2);
      }

      nav a::after {
        background: rgba(226, 232, 240, 0.9);
      }

      p,
      .card-body p,
      .contact-item span,
      label {
        color: rgba(226, 232, 240, 0.78);
      }

      .project-card,
      #admin,
      .admin-card,
      .category-item,
      .work-item,
      .image-item,
      .contact-card {
        background: rgba(15, 23, 42, 0.84);
        box-shadow: none;
        border-color: rgba(148, 163, 184, 0.24);
      }

      input,
      textarea,
      select {
        background: rgba(15, 23, 42, 0.6);
        color: inherit;
      }

      .button.secondary {
        background: rgba(148, 163, 184, 0.15);
        color: inherit;
        border-color: rgba(148, 163, 184, 0.35);
      }

      .gallery-empty {
        background: rgba(15, 23, 42, 0.55);
      }

      footer {
        background: #020617;
      }
  </style>
</head>
<body>
  <header>
    <div class="nav-bar">
      <a class="logo" href="#home" aria-label="返回首页">
        <span class="logo-mark" id="logo-mark"></span>
        <span id="company-name"></span>
      </a>
      <nav aria-label="站点导航">
        <a href="#home">首页</a>
        <a href="#works">作品</a>
        <a href="#contact">联系方式</a>
  <a href="#admin">登录</a>
      </nav>
    </div>
  </header>

  <main>
    <section id="home" class="hero">
      <span class="pill" id="hero-pill"></span>
      <div>
        <h1 id="hero-title"></h1>
      </div>
      <p class="hero-intro" id="hero-intro"></p>
      <div class="hero-meta">
        <div>
          <strong id="hero-project-count">0</strong>
          <span class="tag">已发布作品</span>
        </div>
        <div>
          <strong id="hero-category-count">0</strong>
          <span class="tag">作品系列</span>
        </div>
        <div>
          <strong id="hero-since"></strong>
          <span class="tag" id="hero-signature"></span>
        </div>
      </div>
    </section>

    <section id="works">
      <div class="section-head">
        <h2 id="works-title"></h2>
        <p id="works-description"></p>
      </div>
      <div class="filters" id="category-filters" role="tablist" aria-label="作品分类筛选"></div>
      <div class="gallery-grid" id="gallery-grid" aria-live="polite"></div>
      <div class="gallery-empty" id="gallery-empty" hidden>
        暂无作品，请在后台添加新的项目。
      </div>
    </section>

    <section id="contact">
      <div class="section-head">
        <h2 id="contact-title"></h2>
        <p id="contact-description"></p>
      </div>
      <div class="contact-card">
        <div class="contact-grid" id="contact-grid"></div>
        <div class="divider"></div>
        <p id="contact-note"></p>
      </div>
    </section>

    <section id="admin" aria-live="polite">
      <div class="section-head">
        <h2 id="admin-title"></h2>
        <p id="admin-description"></p>
      </div>
      <div id="admin-shell"></div>
    </section>
  </main>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-labelledby="lightbox-title">
    <div class="lightbox-content">
      <div class="lightbox-media">
        <button class="control lightbox-nav" id="lightbox-prev" aria-label="上一张">←</button>
        <img id="lightbox-image" src="" alt="" />
        <button class="control lightbox-nav" id="lightbox-next" aria-label="下一张">→</button>
      </div>
      <div class="lightbox-meta">
        <div>
          <h3 id="lightbox-title"></h3>
          <p id="lightbox-caption"></p>
        </div>
        <div class="lightbox-controls">
          <button class="control" id="lightbox-close">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    © <span id="footer-year"></span> <span id="footer-branding">EraWood Modular Living</span> · <span id="footer-tagline"></span>
  </footer>

  <script>
    const STORAGE_KEY = 'erawood-portfolio-data-v1';
    const AUTH_KEY = 'erawood-portfolio-auth';

    const palette = ['#5B8C85', '#3D405B', '#ED6A5A', '#406882', '#F4A259'];
    const IMAGE_SCALE_MIN = 0.5;
    const IMAGE_SCALE_MAX = 2.5;
    const IMAGE_OFFSET_MIN = -60;
    const IMAGE_OFFSET_MAX = 60;

    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    function defaultImageTransform() {
      return { scale: 1, offsetX: 0, offsetY: 0 };
    }

    function ensureImageTransform(transform) {
      const defaults = defaultImageTransform();
      if (!transform || typeof transform !== 'object') {
        return { ...defaults };
      }
      const scale = Number.parseFloat(transform.scale);
      const offsetX = Number.parseFloat(transform.offsetX);
      const offsetY = Number.parseFloat(transform.offsetY);
      return {
        scale: clamp(Number.isFinite(scale) ? scale : defaults.scale, IMAGE_SCALE_MIN, IMAGE_SCALE_MAX),
        offsetX: clamp(Number.isFinite(offsetX) ? offsetX : defaults.offsetX, IMAGE_OFFSET_MIN, IMAGE_OFFSET_MAX),
        offsetY: clamp(Number.isFinite(offsetY) ? offsetY : defaults.offsetY, IMAGE_OFFSET_MIN, IMAGE_OFFSET_MAX)
      };
    }

    function isDefaultTransform(transform) {
      const sanitized = ensureImageTransform(transform);
      return Math.abs(sanitized.scale - 1) < 0.001 && Math.abs(sanitized.offsetX) < 0.5 && Math.abs(sanitized.offsetY) < 0.5;
    }

    function buildImageTransform(transform) {
      const sanitized = ensureImageTransform(transform);
      return `translate(${sanitized.offsetX}%, ${sanitized.offsetY}%) scale(${sanitized.scale})`;
    }

    function applyImageTransform(element, transform) {
      if (!element) return;
      element.style.transform = buildImageTransform(transform);
    }

    function formatScaleValue(scale) {
      return `${scale.toFixed(2)}×`;
    }

    function formatOffsetValue(value) {
      const rounded = Math.round(value);
      const prefix = rounded > 0 ? '+' : '';
      return `${prefix}${rounded}%`;
    }

    function ensureBranding(branding) {
      const defaults = {
        companyName: 'EraWood Studio',
        logoText: 'EW',
        logoImage: '',
        companyIntro: '以模块化建构自然栖居，连接城市与山野的可持续空间。',
        logoTransform: defaultImageTransform()
      };
      if (!branding || typeof branding !== 'object') {
        return { ...defaults };
      }
      const companyName =
        typeof branding.companyName === 'string' && branding.companyName.trim()
          ? branding.companyName.trim()
          : defaults.companyName;
      const logoText =
        typeof branding.logoText === 'string' && branding.logoText.trim()
          ? branding.logoText.trim()
          : (companyName.slice(0, 2) || defaults.logoText).toUpperCase();
      const logoImage = typeof branding.logoImage === 'string' ? branding.logoImage : '';
      const companyIntro =
        typeof branding.companyIntro === 'string'
          ? branding.companyIntro.trim()
          : defaults.companyIntro;
      const logoTransform = ensureImageTransform(branding.logoTransform);
      return { companyName, logoText, logoImage, companyIntro, logoTransform };
    }

    function ensureHero(hero) {
      const defaults = {
        pill: '模块化木结构｜可持续建筑',
        title: '以自然为灵感，打造轻盈而温暖的模块化栖居空间',
        intro:
          'EraWood 专注模块化木结构建筑 15 年，以工业化精准制造与现场快速拼装，为城市品牌与自然度假项目打造高品质空间。',
        since: '2009-2024',
        signature: 'EraWood 设计与制造'
      };
      const result = { ...defaults };
      if (!hero || typeof hero !== 'object') {
        return result;
      }
      if (Object.prototype.hasOwnProperty.call(hero, 'pill') && typeof hero.pill === 'string') {
        result.pill = hero.pill.trim();
      }
      if (Object.prototype.hasOwnProperty.call(hero, 'title') && typeof hero.title === 'string') {
        result.title = hero.title.trim();
      }
      if (Object.prototype.hasOwnProperty.call(hero, 'intro') && typeof hero.intro === 'string') {
        result.intro = hero.intro.trim();
      }
      if (Object.prototype.hasOwnProperty.call(hero, 'since') && typeof hero.since === 'string') {
        result.since = hero.since.trim();
      }
      if (Object.prototype.hasOwnProperty.call(hero, 'signature') && typeof hero.signature === 'string') {
        result.signature = hero.signature.trim();
      }
      return result;
    }

    function ensureSections(sections) {
      const defaults = {
        works: {
          title: '模块化建筑作品精选',
          description:
            '从山野木屋、城市展厅到旅居营地，我们将模块化技术与木结构美学结合，创造出灵活、环保且富有情感的空间体验。点击任一作品，即可逐张浏览高清效果图。'
        },
        contact: {
          title: '联系我们',
          description:
            '欢迎体验 EraWood 的模块化建筑解决方案。我们提供从概念设计、结构生产到现场安装的全流程服务，助力品牌打造具有温度的空间。'
        },
        admin: {
          title: '登录',
          description:
            '请登录以维护作品分类、项目内容和图集。所有数据保存于浏览器本地存储，可离线使用。'
        },
        footer: {
          tagline: '以模块化建构自然栖居'
        }
      };

      const result = {
        works: { ...defaults.works },
        contact: { ...defaults.contact },
        admin: { ...defaults.admin },
        footer: { ...defaults.footer }
      };

      if (!sections || typeof sections !== 'object') {
        return result;
      }

      if (sections.works && typeof sections.works === 'object') {
        if (Object.prototype.hasOwnProperty.call(sections.works, 'title') && typeof sections.works.title === 'string') {
          result.works.title = sections.works.title.trim();
        }
        if (
          Object.prototype.hasOwnProperty.call(sections.works, 'description') &&
          typeof sections.works.description === 'string'
        ) {
          result.works.description = sections.works.description.trim();
        }
      }

      if (sections.contact && typeof sections.contact === 'object') {
        if (Object.prototype.hasOwnProperty.call(sections.contact, 'title') && typeof sections.contact.title === 'string') {
          result.contact.title = sections.contact.title.trim();
        }
        if (
          Object.prototype.hasOwnProperty.call(sections.contact, 'description') &&
          typeof sections.contact.description === 'string'
        ) {
          result.contact.description = sections.contact.description.trim();
        }
      }

      if (sections.admin && typeof sections.admin === 'object') {
        if (Object.prototype.hasOwnProperty.call(sections.admin, 'title') && typeof sections.admin.title === 'string') {
          result.admin.title = sections.admin.title.trim();
        }
        if (
          Object.prototype.hasOwnProperty.call(sections.admin, 'description') &&
          typeof sections.admin.description === 'string'
        ) {
          result.admin.description = sections.admin.description.trim();
        }
      }

      if (sections.footer && typeof sections.footer === 'object') {
        if (
          Object.prototype.hasOwnProperty.call(sections.footer, 'tagline') &&
          typeof sections.footer.tagline === 'string'
        ) {
          result.footer.tagline = sections.footer.tagline.trim();
        }
      }

      return result;
    }

    function ensureContact(contact) {
      const defaults = {
        phone: '+86 21 8888 6688',
        email: 'hello@erawood.com',
        address: '上海市杨浦区创智天地设计中心 A 座 5F',
        wechat: 'EraWood_Studio',
        note: '如需定制方案或获取 BIM/施工资料，请通过电话或邮件与我们联系，我们将在 1 个工作日内回复。'
      };
      const result = { ...defaults };
      if (!contact || typeof contact !== 'object') {
        return result;
      }
      ['phone', 'email', 'address', 'wechat', 'note'].forEach((field) => {
        if (Object.prototype.hasOwnProperty.call(contact, field) && typeof contact[field] === 'string') {
          result[field] = contact[field].trim();
        }
      });
      return result;
    }

    function uid(prefix) {
      const random = window.crypto && typeof window.crypto.randomUUID === 'function'
        ? window.crypto.randomUUID()
        : `${Math.random().toString(36).slice(2, 10)}${Date.now().toString(36)}`;
      return `${prefix}-${random}`;
    }

    function createPlaceholder(label, color) {
      // 生成纯黑背景的 SVG 占位图，文本颜色保持透明白以便不可见（纯黑只有背景）
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 500"><rect width="800" height="500" fill="#000000" rx="0"/></svg>`;
      return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
    }

    function buildWork(id, name, description, location, area, year, labels, color, specs = {}) {
      const images = labels.map((label, index) => ({
        id: `${id}-img-${index + 1}`,
        alt: `${name} - ${label}`,
        src: createPlaceholder(`${name} ${label}`, color),
        transform: defaultImageTransform()
      }));
      const normalizedSpecs = {
        interiorArea: typeof specs.interiorArea === 'string' ? specs.interiorArea : '',
        footprint: typeof specs.footprint === 'string' ? specs.footprint : '',
        productSize: typeof specs.productSize === 'string' ? specs.productSize : '',
        roomType: typeof specs.roomType === 'string' ? specs.roomType : ''
      };

      return {
        id,
        name,
        description,
        location,
        area,
        year,
        interiorArea: normalizedSpecs.interiorArea,
        footprint: normalizedSpecs.footprint,
        productSize: normalizedSpecs.productSize,
        roomType: normalizedSpecs.roomType,
        coverId: images[0]?.id || null,
        images
      };
    }

    function buildDefaultData() {
      const categories = [
        {
          id: 'cat-forest',
          name: '森林系列',
          description: '与山林共生的木屋产品线，强调轻盈结构与自然景观的融合。',
          works: [
            buildWork(
              'work-skyline',
              '天际木屋',
              '两组模块搭建的双层木屋，通过大面积落地玻璃框住山谷云海，呈现沉浸式自然居住体验。',
              '浙江 · 莫干山',
              '118㎡',
              '2023',
              ['晨雾立面', '一层公共空间', '悬浮楼梯', '主卧观景窗'],
              palette[0],
              {
                interiorArea: '96㎡',
                footprint: '118㎡',
                productSize: '12m × 9m × 6m',
                roomType: '2 卧 1 客厅'
              }
            ),
            buildWork(
              'work-moss',
              '苔原旅居站',
              '以可回收钢木混合框架构成的模块化旅居站，可在 48 小时内部署完成，适配不同地形与气候。',
              '四川 · 九寨沟',
              '86㎡',
              '2022',
              ['集群夜景', '入口廊道', '客房内部'],
              palette[0],
              {
                interiorArea: '68㎡',
                footprint: '86㎡',
                productSize: '10m × 8m × 5m',
                roomType: '1 卧 1 起居'
              }
            )
          ]
        },
        {
          id: 'cat-urban',
          name: '城市展厅',
          description: '针对城市商业场景打造的模块化展厅体系，兼顾快速安装与品牌调性。',
          works: [
            buildWork(
              'work-ripple',
              '涟漪体验馆',
              '可拆卸的环形展厅模块，形成连续的展示动线，适合品牌快闪与巡回展览。',
              '上海 · 西岸',
              '260㎡',
              '2024',
              ['外立面', '品牌展示区', '洽谈区'],
              palette[1],
              {
                interiorArea: '210㎡',
                footprint: '260㎡',
                productSize: '18m × 14m × 6m',
                roomType: '开放展示模块'
              }
            )
          ]
        },
        {
          id: 'cat-resort',
          name: '旅居营地',
          description: '以营地运营为核心的模块化轻型建筑，注重舒适度与运维效率。',
          works: [
            buildWork(
              'work-dune',
              '沙丘会客厅',
              '采用模块化木梁与织物围护打造的半户外会客空间，为沿海营地提供全天候社交场景。',
              '海南 · 万宁',
              '150㎡',
              '2021',
              ['黄昏氛围', '室内酒吧', '顶棚结构'],
              palette[2],
              {
                interiorArea: '110㎡',
                footprint: '150㎡',
                productSize: '22m × 7m × 5m',
                roomType: '多功能社交空间'
              }
            ),
            buildWork(
              'work-horizon',
              '地平线营地客房',
              '标准化单元结合可替换立面系统，实现快速部署与多景观适配的营地住宿单元。',
              '内蒙古 · 乌兰布统',
              '42㎡',
              '2020',
              ['整体外观', '床头阅读区', '卫浴空间'],
              palette[2],
              {
                interiorArea: '36㎡',
                footprint: '42㎡',
                productSize: '8m × 5m × 4m',
                roomType: '双人客房单元'
              }
            )
          ]
        }
      ];

      return {
        hero: ensureHero({
          pill: '模块化木结构｜可持续建筑',
          title: '以自然为灵感，打造轻盈而温暖的模块化栖居空间',
          intro:
            'EraWood 专注模块化木结构建筑 15 年，以工业化精准制造与现场快速拼装，为城市品牌与自然度假项目打造高品质空间。',
          since: '2009-2024',
          signature: 'EraWood 设计与制造'
        }),
        sections: ensureSections({
          works: {
            title: '模块化建筑作品精选',
            description:
              '从山野木屋、城市展厅到旅居营地，我们将模块化技术与木结构美学结合，创造出灵活、环保且富有情感的空间体验。点击任一作品，即可逐张浏览高清效果图。'
          },
          contact: {
            title: '联系我们',
            description:
              '欢迎体验 EraWood 的模块化建筑解决方案。我们提供从概念设计、结构生产到现场安装的全流程服务，助力品牌打造具有温度的空间。'
          },
          admin: {
            title: '登录',
            description:
              '请登录以维护作品分类、项目内容和图集。所有数据保存于浏览器本地存储，可离线使用。'
          },
          footer: {
            tagline: '以模块化建构自然栖居'
          }
        }),
        branding: ensureBranding({
          companyName: 'EraWood Studio',
          logoText: 'EW',
          logoImage: '',
          companyIntro: '以模块化建构自然栖居，连接城市与山野的可持续空间。'
        }),
        categories,
        contact: ensureContact({
          phone: '+86 21 8888 6688',
          email: 'hello@erawood.com',
          address: '上海市杨浦区创智天地设计中心 A 座 5F',
          wechat: 'EraWood_Studio',
          note: '如需定制方案或获取 BIM/施工资料，请通过电话或邮件与我们联系，我们将在 1 个工作日内回复。'
        })
      };
    }

    function ensureDataSchema(raw) {
      const fallback = buildDefaultData();
      if (!raw || typeof raw !== 'object') {
        return fallback;
      }

      const data = {
        hero: ensureHero(raw.hero),
        sections: ensureSections(raw.sections),
        branding: ensureBranding(raw.branding),
        categories: [],
        contact: ensureContact(raw.contact)
      };

      if (Array.isArray(raw.categories)) {
        data.categories = raw.categories.map((category, catIndex) => {
          const safeCategory = {
            id: category?.id || uid('cat'),
            name:
              typeof category?.name === 'string' && category.name.trim()
                ? category.name
                : `未命名分类 ${catIndex + 1}`,
            description: typeof category?.description === 'string' ? category.description : '',
            works: []
          };

          if (Array.isArray(category?.works)) {
            safeCategory.works = category.works.map((work, workIndex) => {
              const safeWork = {
                id: work?.id || uid('work'),
                name:
                  typeof work?.name === 'string' && work.name.trim()
                    ? work.name
                    : `未命名作品 ${workIndex + 1}`,
                description: typeof work?.description === 'string' ? work.description : '',
                location: typeof work?.location === 'string' ? work.location : '',
                area: typeof work?.area === 'string' ? work.area : '',
                year: typeof work?.year === 'string' ? work.year : '',
                interiorArea: typeof work?.interiorArea === 'string' ? work.interiorArea : '',
                footprint: typeof work?.footprint === 'string' ? work.footprint : '',
                productSize: typeof work?.productSize === 'string' ? work.productSize : '',
                roomType: typeof work?.roomType === 'string' ? work.roomType : '',
                coverId: null,
                images: []
              };

              if (Array.isArray(work?.images) && work.images.length) {
                safeWork.images = work.images
                  .filter((image) => image && typeof image === 'object' && image.src)
                  .map((image, imageIndex) => ({
                    id: image.id || uid('img'),
                    alt:
                      typeof image.alt === 'string'
                        ? image.alt
                        : `${safeWork.name} 图片 ${imageIndex + 1}`,
                    src: image.src,
                    transform: ensureImageTransform(image.transform)
                  }));
              }

              if (!safeWork.images.length) {
                const placeholder = {
                  id: uid('img'),
                  alt: `${safeWork.name} 预览`,
                  src: createPlaceholder(
                    safeWork.name || `作品 ${workIndex + 1}`,
                    palette[(catIndex + workIndex) % palette.length]
                  ),
                  transform: defaultImageTransform()
                };
                safeWork.images = [placeholder];
              }

              safeWork.images = safeWork.images.map((image) => ({
                ...image,
                transform: ensureImageTransform(image.transform)
              }));

              safeWork.coverId =
                safeWork.images.find((img) => img.id === work?.coverId)?.id || safeWork.images[0]?.id || null;

              return safeWork;
            });
          }

          return safeCategory;
        });
      } else {
        data.categories = fallback.categories;
      }

      if (!raw.sections || typeof raw.sections !== 'object') {
        data.sections = fallback.sections;
      }

      return data;
    }

    // 将图片引用规范化为相对于 index.html 的路径
    // 规则：
    // - data: URI、http(s):// 或以 / 开头 的绝对路径保持不变
    // - 已包含路径分隔符（/）的相对路径保持不变
    // - 其他纯文件名（例如 "work-abc.jpg"）会自动前缀为 "images/<filename>"
    function normalizeImageSrc(src) {
      if (!src || typeof src !== 'string') return src;
      const trimmed = src.trim();
      if (!trimmed) return trimmed;
      if (/^data:/i.test(trimmed)) return trimmed;
      if (/^https?:\/\//i.test(trimmed)) return trimmed;
      if (trimmed.startsWith('/')) return trimmed;
      // 若是包含路径分隔符，则认为已提供相对路径；若是裸文件名也保留原样（不自动添加目录前缀）
      return trimmed;
    }

  // 可选：使用 jsDelivr 从 GitHub 仓库作为镜像托管静态资源。
    // 配置方式：在控制台或在页面初始化前设置
    //   window.USE_JSDELIVR = true;
    //   window.JSDELIVR_REPO = '用户名/仓库名@分支或tag'; // 示例 'lylsy921725-bit/erawoodfabrication@latest'
    // 如果启用，页面会把裸文件名替换为 jsDelivrcdn 地址：
    // https://cdn.jsdelivr.net/gh/<repo>/<path>
  // 默认启用 jsDelivr 镜像，指向你的仓库（可在控制台覆盖）
  window.USE_JSDELIVR = window.USE_JSDELIVR === true || true;
  window.JSDELIVR_REPO = window.JSDELIVR_REPO || 'lylsy921725-bit/erawoodfabrication@main';

  function jsDelivrUrlFor(src) {
      try {
        if (!window.USE_JSDELIVR) return src;
        if (!src || typeof src !== 'string') return src;
        // 如果已经是绝对 URL 或 data URI，保持不变
        if (/^https?:\/\//i.test(src) || /^data:/i.test(src)) return src;
        // JSDelivr expects repo in form user/repo@version
        const repo = (window.JSDELIVR_REPO && window.JSDELIVR_REPO.toString().trim()) || '';
        if (!repo) return src;
        // 移除任何前导 ./ 或 /
        const path = src.replace(/^\.?\//, '');
        // encode each path segment
        const parts = path.split('/').map(encodeURIComponent).join('/');
        return `https://cdn.jsdelivr.net/gh/${repo}/${parts}`;
      } catch (e) {
        return src;
      }
    }

    // 懒加载器：使用 IntersectionObserver 在图片接近视口时再设置 src
    // 优点：减少移动端首屏和并发下载压力，提升首屏可见内容加载速度
    // 逻辑：图片元素需设置 data-src 为要加载的缩略图或原图（已通过 jsDelivrUrlFor 包装），
    // 并设置 data-full-src 存放原始大图地址（用于 thumb 失败回退或 lightbox）。
    // 如果不支持 IntersectionObserver，会回退到直接加载 data-src。
    const LazyLoader = (function () {
      let observer = null;

      function onIntersection(entries) {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target;
            loadImage(img);
            if (observer && img) observer.unobserve(img);
          }
        });
      }

      function loadImage(img) {
        if (!img || !img.dataset) return;
        // already loaded
        if (img.dataset._loaded) return;
        const toLoad = img.dataset.src || img.dataset.thumbSrc || img.dataset.fullSrc || img.dataset.fullsrc;
        if (!toLoad) return;
        img.dataset._loaded = '1';
        // 绑定错误回退：如果是 thumb，则回退到 fullSrc
        function onImgError() {
          try {
            img.removeEventListener('error', onImgError);
          } catch (e) {}
          // 如果当前 src 含有 "-thumb" 标识，则回退到 fullSrc
          try {
            const cur = img.getAttribute('src') || '';
            if (cur.indexOf('-thumb') !== -1 && img.dataset.fullSrc) {
              img.src = img.dataset.fullSrc;
              return;
            }
            // 如果当前请求来自 jsDelivr（cdn.jsdelivr.net）且失败，则尝试使用原始相对路径（保留中文名）回退
            if (cur.indexOf('cdn.jsdelivr.net') !== -1 && img.dataset.originalPath) {
              try {
                img.src = img.dataset.originalPath;
                return;
              } catch (e) {}
            }
          } catch (e) {}
        }

        img.addEventListener('error', onImgError);
        // 开始加载
        try {
          img.src = toLoad;
        } catch (e) {
          // ignore
        }
      }

      function observeAll(root = null) {
        const images = Array.from(document.querySelectorAll('img[data-src], img[data-thumb-src], img[data-full-src]'));
        if (!images.length) return;
        if ('IntersectionObserver' in window) {
          if (!observer) {
            observer = new IntersectionObserver(onIntersection, { root: null, rootMargin: '200px', threshold: 0.05 });
          }
          images.forEach((img) => {
            // if already has a real src (loaded), skip
            if (img.dataset._loaded) return;
            observer.observe(img);
          });
        } else {
          // 回退：直接加载所有 data-src
          images.forEach((img) => loadImage(img));
        }
      }

      return { observeAll, loadImage };
    })();

    // 将用户上传的原始文件名规范为安全的文件名（用于导出时生成稳定的文件名）
    function sanitizeFilename(name) {
      if (!name || typeof name !== 'string') return '';
      // 去除路径并取文件名部分
      const base = name.split(/[/\\]/).pop();
      // 将空格替换为下划线，移除不安全字符，保留英文、数字、中文、连字符、下划线和点
      const cleaned = base
        .trim()
        .replace(/\s+/g, '_')
        .replace(/[^\w\-.\u4e00-\u9fa5]/g, '')
        .slice(0, 180);
      return cleaned || 'file';
    }

    function loadData() {
      try {
        const saved = window.localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = ensureDataSchema(JSON.parse(saved));
          // 如果本地存储中存在旧的 admin 文案（例如“后台管理”或包含旧默认凭据），
          // 强制使用当前代码中定义的 admin 区块默认文本，避免页面显示过时说明。
          try {
            const defaults = ensureSections();
            parsed.sections = parsed.sections || {};
            parsed.sections.admin = defaults.admin;
          } catch (e) {
            // 若 ensureSections 出问题，仍返回解析后的数据作为回退
            console.warn('覆盖本地存储 admin 文案时出错，使用存储的数据。', e);
          }
          return parsed;
        }
      } catch (error) {
        console.warn('无法读取本地存储，将使用默认数据。', error);
      }
      return ensureDataSchema(buildDefaultData());
    }

    function saveData(data) {
      try {
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (error) {
        console.warn('保存数据到本地存储失败。', error);
      }
    }

    function loadAuthState() {
      return window.localStorage.getItem(AUTH_KEY) === 'true';
    }

    function saveAuthState(value) {
      window.localStorage.setItem(AUTH_KEY, value ? 'true' : 'false');
    }

    // 尝试从远程相对路径预加载 JSON 数据（用于 GitHub Pages 等托管场景）
    // 将依次尝试常见的导出文件名，如果成功则使用该数据并保存到 localStorage。
    async function fetchRemoteData() {
      const candidates = [
        './erawood-portfolio.json',
        './erawood-portfolio-' + new Date().toISOString().slice(0,10) + '.json',
        './erawood-portfolio-data.json',
        './erawood-portfolio-data-v1.json',
        './erawood-portfolio-v1.json',
        './data.json',
        './portfolio.json',
        '/erawood-portfolio.json'
      ];

      for (const path of candidates) {
        try {
          const resp = await fetch(path, { cache: 'no-cache' });
          if (!resp.ok) continue;
          const parsed = await resp.json();
          const normalized = ensureDataSchema(parsed);
          // 覆盖 state.data 并保存到 localStorage
          state.data = normalized;
          try { saveData(state.data); } catch (e) { console.warn('保存远程数据到 localStorage 失败', e); }
          console.info('已从远程预加载数据：', path);
          return true;
        } catch (error) {
          // 忽略并尝试下一个路径
          // console.debug('尝试加载远程数据失败：', path, error);
        }
      }
      // 如果远程 JSON 未找到，可回退到页面内嵌的图片清单（如果存在）
      // 支持两种 manifest 格式：
      // 1) 简单数组： window.EMBEDDED_IMAGE_MANIFEST = ['images/1.png', 'images/2.png']
      // 2) 详细数组： window.EMBEDDED_IMAGE_MANIFEST = [{src: 'images/1.png', title: '作品A', desc: '说明'}, ...]
      try {
        if (Array.isArray(window.EMBEDDED_IMAGE_MANIFEST) && window.EMBEDDED_IMAGE_MANIFEST.length) {
          const built = buildDataFromImageManifest(window.EMBEDDED_IMAGE_MANIFEST);
          if (built) {
            state.data = built;
            try { saveData(state.data); } catch (e) { console.warn('保存内嵌 manifest 到 localStorage 失败', e); }
            console.info('已使用页面内嵌图片清单构建数据。');
            return true;
          }
        }
      } catch (e) {
        console.warn('使用内嵌图片清单构建数据时出错。', e);
      }

      return false;
    }

    // 根据页面内嵌的图片清单构建最小化的 state.data
    function buildDataFromImageManifest(manifest) {
      try {
        const categories = [];
        const works = [];
        manifest.forEach((item, idx) => {
          if (!item) return;
          if (typeof item === 'string') {
            const id = `img-${idx + 1}`;
            works.push({
              id: `work-${id}`,
              name: `作品 ${idx + 1}`,
              description: '',
              location: '',
              area: '',
              year: '',
              interiorArea: '',
              footprint: '',
              productSize: '',
              roomType: '',
              coverId: `${id}`,
              images: [{ id: id, alt: '', src: item, transform: defaultImageTransform() }]
            });
          } else if (typeof item === 'object' && item.src) {
            const id = item.id || `img-${idx + 1}`;
            works.push({
              id: `work-${id}`,
              name: item.title || `作品 ${idx + 1}`,
              description: item.desc || '',
              location: item.location || '',
              area: item.area || '',
              year: item.year || '',
              interiorArea: item.interiorArea || '',
              footprint: item.footprint || '',
              productSize: item.productSize || '',
              roomType: item.roomType || '',
              coverId: id,
              images: [{ id: id, alt: item.alt || '', src: item.src, transform: defaultImageTransform() }]
            });
          }
        });

        if (!works.length) return null;
        categories.push({ id: 'cat-embedded', name: '内嵌图片', description: '', works });

        const data = buildDefaultData();
        data.categories = categories;
        return ensureDataSchema(data);
      } catch (e) {
        console.warn('构建内嵌 manifest 数据失败', e);
        return null;
      }
    }

    function defaultAdminState() {
      return {
        selectedCategory: '',
        workDetailsOpen: {},
        workListScroll: 0,
        focusWorkId: ''
      };
    }

    const state = {
      data: loadData(),
      filter: 'all',
      isAuthenticated: loadAuthState(),
      lightbox: {
        categoryId: null,
        workId: null,
        index: 0
      },
      ui: {
        admin: defaultAdminState()
      }
    };

    function resetAdminUIState() {
      if (!state.ui) {
        state.ui = {};
      }
      const next = defaultAdminState();
      state.ui.admin = next;
      return next;
    }

    function ensureAdminUI() {
      if (!state.ui) {
        state.ui = {};
      }
      if (!state.ui.admin) {
        state.ui.admin = defaultAdminState();
      }
      return state.ui.admin;
    }

    function updateBrandingFormState() {
      const brandingData = ensureBranding(state.data.branding);
      const clearButton = document.getElementById('branding-clear-logo');
      if (clearButton) {
        clearButton.disabled = !brandingData.logoImage;
      }
    }

    function renderBranding() {
      const branding = ensureBranding(state.data.branding);
      state.data.branding = branding;
      const logoTransform = ensureImageTransform(branding.logoTransform);

      const mark = document.getElementById('logo-mark');
      if (mark) {
        mark.innerHTML = '';
        if (branding.logoImage) {
          const img = document.createElement('img');
          img.src = jsDelivrUrlFor(branding.logoImage);
          img.alt = `${branding.companyName || '品牌'} Logo`;
          applyImageTransform(img, logoTransform);
          mark.appendChild(img);
        } else {
          mark.textContent = branding.logoText || 'LOGO';
        }
      }

      const companyNameEl = document.getElementById('company-name');
      if (companyNameEl) {
        companyNameEl.textContent = branding.companyName || '未命名品牌';
      }

      const navLogo = document.querySelector('a.logo');
      if (navLogo) {
        navLogo.setAttribute('aria-label', branding.companyName ? `返回首页：${branding.companyName}` : '返回首页');
      }

      const adminMark = document.getElementById('admin-logo-mark');
      if (adminMark) {
        adminMark.innerHTML = '';
        if (branding.logoImage) {
          const img = document.createElement('img');
          img.src = branding.logoImage;
          img.alt = `${branding.companyName || '品牌'} Logo`;
          applyImageTransform(img, logoTransform);
          adminMark.appendChild(img);
        } else {
          adminMark.textContent = branding.logoText || 'LOGO';
        }
      }

      const adminLogoUpload = document.getElementById('admin-logo-upload');
      if (adminLogoUpload) {
        const hasImage = Boolean(branding.logoImage);
        adminLogoUpload.dataset.state = hasImage ? 'image' : 'empty';
        const label = hasImage ? '点击更换 Logo 图片' : '点击上传 Logo 图片';
        adminLogoUpload.setAttribute('aria-label', label);
        adminLogoUpload.title = label;
      }

      const adminName = document.getElementById('admin-company-name');
      if (adminName) {
        adminName.textContent = branding.companyName || '未命名品牌';
      }

      const adminIntro = document.getElementById('admin-brand-intro');
      if (adminIntro) {
        adminIntro.textContent =
          branding.companyIntro || '请在下方填写品牌简介，方便访客了解您的品牌。';
      }

      const transformContainer = document.getElementById('branding-logo-transform');
      if (transformContainer) {
        transformContainer.classList.toggle('disabled', !branding.logoImage);
        updateTransformIndicators(transformContainer, logoTransform);
        transformContainer
          .querySelectorAll('[data-logo-transform]')
          .forEach((input) => {
            const field = input.dataset.logoTransform;
            if (!field) return;
            input.value = logoTransform[field];
            input.disabled = !branding.logoImage;
          });
      }

      const companyInput = document.querySelector('#admin-branding-form [name="companyName"]');
      if (companyInput) {
        companyInput.value = branding.companyName || '';
      }

      const logoTextInput = document.querySelector('#admin-branding-form [name="logoText"]');
      if (logoTextInput) {
        logoTextInput.value = branding.logoText || '';
      }

      const introInput = document.querySelector('#admin-branding-form [name="companyIntro"]');
      if (introInput) {
        introInput.value = branding.companyIntro || '';
      }

      const footerBranding = document.getElementById('footer-branding');
      if (footerBranding) {
        footerBranding.textContent = branding.companyName || 'EraWood Modular Living';
      }

      document.title = branding.companyName ? `${branding.companyName} 模块化建筑作品集` : '模块化建筑作品集';

      updateBrandingFormState();
    }

    function findCategory(categoryId) {
      return state.data.categories.find((cat) => cat.id === categoryId) || null;
    }

    function findWork(categoryId, workId) {
      const category = findCategory(categoryId);
      if (!category) return null;
      return category.works.find((work) => work.id === workId) || null;
    }

    function renderHero() {
      const hero = ensureHero(state.data.hero);
      state.data.hero = hero;

      const heroPill = document.getElementById('hero-pill');
      if (heroPill) {
        heroPill.textContent = hero.pill;
      }

      const heroTitle = document.getElementById('hero-title');
      if (heroTitle) {
        heroTitle.textContent = hero.title;
      }

      const heroIntro = document.getElementById('hero-intro');
      if (heroIntro) {
        heroIntro.textContent = hero.intro;
      }

      const heroSince = document.getElementById('hero-since');
      if (heroSince) {
        heroSince.textContent = hero.since;
      }

      const heroSignature = document.getElementById('hero-signature');
      if (heroSignature) {
        heroSignature.textContent = hero.signature;
      }

      const projectCount = state.data.categories.reduce((total, category) => total + category.works.length, 0);
      const projectCountEl = document.getElementById('hero-project-count');
      if (projectCountEl) {
        projectCountEl.textContent = projectCount.toString();
      }

      const categoryCountEl = document.getElementById('hero-category-count');
      if (categoryCountEl) {
        categoryCountEl.textContent = state.data.categories.length.toString();
      }
    }

    function renderSectionsText() {
      const sections = ensureSections(state.data.sections);
      state.data.sections = sections;

      const worksTitle = document.getElementById('works-title');
      if (worksTitle) {
        worksTitle.textContent = sections.works.title;
      }

      const worksDescription = document.getElementById('works-description');
      if (worksDescription) {
        worksDescription.textContent = sections.works.description;
      }

      const contactTitle = document.getElementById('contact-title');
      if (contactTitle) {
        contactTitle.textContent = sections.contact.title;
      }

      const contactDescription = document.getElementById('contact-description');
      if (contactDescription) {
        contactDescription.textContent = sections.contact.description;
      }

      const adminTitle = document.getElementById('admin-title');
      if (adminTitle) {
        adminTitle.textContent = sections.admin.title;
      }

      const adminDescription = document.getElementById('admin-description');
      if (adminDescription) {
        adminDescription.textContent = sections.admin.description;
      }

      const footerTagline = document.getElementById('footer-tagline');
      if (footerTagline) {
        footerTagline.textContent = sections.footer.tagline;
      }
    }

    function renderContact() {
      const contactGrid = document.getElementById('contact-grid');
      const note = document.getElementById('contact-note');
      contactGrid.innerHTML = '';
      const contact = ensureContact(state.data.contact);
      state.data.contact = contact;
      const rows = [
        ['电话', contact.phone || ''],
        ['邮箱', contact.email || ''],
        ['地址', contact.address || ''],
        ['微信', contact.wechat || '']
      ];

      rows
        .filter(([, value]) => value)
        .forEach(([label, value]) => {
          const item = document.createElement('div');
          item.className = 'contact-item';
          const labelEl = document.createElement('span');
          labelEl.textContent = label;
          const valueEl = document.createElement('strong');
          valueEl.textContent = value;
          item.appendChild(labelEl);
          item.appendChild(valueEl);
          contactGrid.appendChild(item);
        });

      note.textContent = contact.note || '';
    }

    function renderFilters() {
      const filterContainer = document.getElementById('category-filters');
      filterContainer.innerHTML = '';

      const allButton = document.createElement('button');
      allButton.className = `filter-button ${state.filter === 'all' ? 'active' : ''}`;
      allButton.textContent = '全部作品';
      allButton.type = 'button';
      allButton.addEventListener('click', () => {
        state.filter = 'all';
        renderFilters();
        renderGallery();
      });
      filterContainer.appendChild(allButton);

      state.data.categories.forEach((category) => {
        const button = document.createElement('button');
        button.className = `filter-button ${state.filter === category.id ? 'active' : ''}`;
        button.textContent = category.name;
        button.type = 'button';
        button.addEventListener('click', () => {
          state.filter = category.id;
          renderFilters();
          renderGallery();
        });
        filterContainer.appendChild(button);
      });
    }

    function getCoverImage(work) {
      if (!work.images?.length) return null;
      if (!work.coverId) return work.images[0];
      return work.images.find((image) => image.id === work.coverId) || work.images[0];
    }

    function renderGallery() {
      const grid = document.getElementById('gallery-grid');
      const empty = document.getElementById('gallery-empty');
      grid.innerHTML = '';

      const categories = state.filter === 'all' ? state.data.categories : state.data.categories.filter((cat) => cat.id === state.filter);
      const works = categories.flatMap((category) => category.works.map((work) => ({ category, work })));

      if (!works.length) {
        empty.hidden = false;
        return;
      }

      empty.hidden = true;

      works.forEach(({ category, work }) => {
        const cover = getCoverImage(work);
        if (cover) {
          cover.transform = ensureImageTransform(cover.transform);
        }
        const transformStyle = buildImageTransform(cover?.transform);
        const card = document.createElement('article');
        card.className = 'project-card';
        card.tabIndex = 0;
        card.setAttribute('role', 'button');
        card.setAttribute('aria-label', `${work.name} · ${category.name}`);

        const cardImage = document.createElement('div');
        cardImage.className = 'card-image';
        const image = document.createElement('img');
        const originalSrc = normalizeImageSrc(cover?.src || '') || '';
        // 尝试 thumb 优先策略，但不要立即赋予 src，改为 data-src 由 LazyLoader 在靠近视口时触发加载
        const thumbSrc = (originalSrc && originalSrc.replace(/(\.[^.]+)$/, '-thumb$1')) || originalSrc;
  const thumbUrl = jsDelivrUrlFor(thumbSrc);
  const fullUrl = jsDelivrUrlFor(originalSrc);
  image.dataset.src = thumbUrl; // 优先加载缩略图（可能是 CDN 地址）
  image.dataset.fullSrc = fullUrl; // 回退或 lightbox 使用原图（CDN 地址）
  // 保留原始相对路径（含中文名），以便在 CDN 失败或 404 时尝试直接使用相对路径访问
  image.dataset.originalPath = originalSrc;
        image.src = createPlaceholder('', '#000'); // 使用纯黑占位图减少空白感
        image.alt = cover?.alt || work.name || '';
        image.loading = 'lazy';
        image.style.transform = transformStyle || '';
        cardImage.appendChild(image);

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header';
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = category.name;
        const title = document.createElement('h3');
        title.textContent = work.name;
        cardHeader.appendChild(tag);
        cardHeader.appendChild(title);

        const description = document.createElement('p');
        description.className = 'card-description';
        description.textContent = work.description || '欢迎在后台补充项目描述。';

        const specList = document.createElement('div');
        specList.className = 'spec-list';
        const specs = [
          ['套内面积', work.interiorArea],
          ['占地面积', work.footprint || work.area],
          ['产品尺寸', work.productSize],
          ['房间类型', work.roomType]
        ];
        specs.forEach(([label, value]) => {
          const row = document.createElement('div');
          row.className = 'spec-item';
          const labelEl = document.createElement('span');
          labelEl.className = 'spec-label';
          labelEl.textContent = `${label}：`;
          const valueEl = document.createElement('span');
          valueEl.className = 'spec-value';
          const specValue =
            typeof value === 'string' && value.trim() ? value.trim() : '待补充';
          valueEl.textContent = specValue;
          row.appendChild(labelEl);
          row.appendChild(valueEl);
          specList.appendChild(row);
        });

        cardBody.appendChild(cardHeader);
        cardBody.appendChild(description);
        cardBody.appendChild(specList);

        card.appendChild(cardImage);
        card.appendChild(cardBody);

        const openLightbox = () => {
          openGalleryModal(category.id, work.id, 0);
        };

        card.addEventListener('click', openLightbox);
        card.addEventListener('keypress', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            openLightbox();
          }
        });

        grid.appendChild(card);
      });

      // 所有新创建的图片元素交给 LazyLoader 管理
      LazyLoader.observeAll();
    }

    function openGalleryModal(categoryId, workId, index) {
      const category = findCategory(categoryId);
      const work = findWork(categoryId, workId);
      if (!category || !work || !work.images.length) return;

      state.lightbox = { categoryId, workId, index };
      updateLightbox();

      const lightbox = document.getElementById('lightbox');
      lightbox.classList.add('open');
    }

    function updateLightbox() {
      const { categoryId, workId, index } = state.lightbox;
      const work = findWork(categoryId, workId);
      if (!work) return;

      const image = work.images[index];
      if (image) {
        image.transform = ensureImageTransform(image.transform);
      }
      const lightboxImage = document.getElementById('lightbox-image');
      if (lightboxImage) {
        const cdnUrl = jsDelivrUrlFor(image?.src || '');
        lightboxImage.alt = image?.alt || work.name;
        lightboxImage.src = cdnUrl;
        // 若 CDN 地址失败（例如中文文件名未命中），回退到相对路径（保留中文名）
        lightboxImage.onerror = function () {
          try {
            lightboxImage.onerror = null;
          } catch (e) {}
          try {
            // 尝试使用原始 src（未经 jsDelivr 包装），works 中保存的 src 保持原样
            lightboxImage.src = image?.src || '';
          } catch (e) {}
        };
        applyImageTransform(lightboxImage, image?.transform);
      }
      document.getElementById('lightbox-title').textContent = work.name;
      document.getElementById('lightbox-caption').textContent = image?.alt || '';

      document.getElementById('lightbox-prev').disabled = index <= 0;
      document.getElementById('lightbox-next').disabled = index >= work.images.length - 1;
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      state.lightbox = { categoryId: null, workId: null, index: 0 };
    }

    function renderAdminShell() {
      const shell = document.getElementById('admin-shell');
      shell.innerHTML = '';

      if (!state.isAuthenticated) {
        const form = document.createElement('form');
        form.className = 'admin-login';
        form.innerHTML = `
          <label for="admin-account">账号</label>
          <input id="admin-account" name="account" type="text" required autocomplete="username" />
          <label for="admin-password">密码</label>
          <input id="admin-password" name="password" type="password" required autocomplete="current-password" />
          <button class="button" type="submit">登录</button>
        `;

        form.addEventListener('submit', (event) => {
          event.preventDefault();
          const account = form.account.value.trim();
          const password = form.password.value.trim();
          if (account === 'erawood666' && password === 'erawood666') {
            state.isAuthenticated = true;
            saveAuthState(true);
            renderAdminShell();
          } else {
            alert('账号或密码不正确，请重试。');
          }
        });

        shell.appendChild(form);
        return;
      }

      ensureAdminUI();
      const branding = ensureBranding(state.data.branding);
      const logoTransform = ensureImageTransform(branding.logoTransform);

      const wrapper = document.createElement('div');
      wrapper.className = 'admin-panels';
      wrapper.innerHTML = `
        <div class="logout-bar">
          <button class="button secondary" id="logout-button">退出登录</button>
        </div>
        <div class="admin-card">
          <h3>站点标识</h3>
          <div class="brand-preview" id="brand-preview">
            <label class="logo upload-target" id="admin-logo-upload" role="button" tabindex="0" for="branding-logo-file" aria-label="点击上传 Logo 图片">
              <span class="logo-mark" id="admin-logo-mark"></span>
              <span id="admin-company-name"></span>
            </label>
            <p class="brand-preview-intro" id="admin-brand-intro">请在下方填写品牌简介，方便访客了解您的品牌。</p>
            <p class="admin-hint">预览与站点导航同步显示，建议上传透明底 PNG 格式。</p>
          </div>
          <form class="inline-form" id="admin-branding-form">
            <label for="branding-company-name">公司名称</label>
            <input id="branding-company-name" type="text" name="companyName" value="${branding.companyName || ''}" placeholder="请输入公司名称" required />
            <label for="branding-logo-text">Logo 文本</label>
            <input id="branding-logo-text" type="text" name="logoText" value="${branding.logoText || ''}" placeholder="例如：EW" maxlength="12" />
            <label for="branding-company-intro">品牌简介</label>
            <textarea id="branding-company-intro" name="companyIntro" rows="3" placeholder="请输入品牌简介，方便访客了解您的品牌。"></textarea>
            <div class="brand-upload">
              <input type="file" id="branding-logo-file" accept="image/png,image/svg+xml,image/jpeg,image/webp" hidden />
              <button class="button secondary" type="button" id="branding-upload-button">上传 Logo 图片</button>
              <button class="button secondary" type="button" id="branding-clear-logo" ${branding.logoImage ? '' : 'disabled'}>移除图片</button>
            </div>
            <div class="image-transform ${branding.logoImage ? '' : 'disabled'}" id="branding-logo-transform">
              <div class="transform-control">
                <div class="transform-label">
                  <span>Logo 缩放</span>
                  <span class="transform-value" data-transform-value="scale">${formatScaleValue(logoTransform.scale)}</span>
                </div>
                <input type="range" min="${IMAGE_SCALE_MIN}" max="${IMAGE_SCALE_MAX}" step="0.01" value="${logoTransform.scale}" data-logo-transform="scale" ${branding.logoImage ? '' : 'disabled'} />
              </div>
              <div class="transform-control">
                <div class="transform-label">
                  <span>水平位置</span>
                  <span class="transform-value" data-transform-value="offsetX">${formatOffsetValue(logoTransform.offsetX)}</span>
                </div>
                <input type="range" min="${IMAGE_OFFSET_MIN}" max="${IMAGE_OFFSET_MAX}" step="1" value="${logoTransform.offsetX}" data-logo-transform="offsetX" ${branding.logoImage ? '' : 'disabled'} />
              </div>
              <div class="transform-control">
                <div class="transform-label">
                  <span>垂直位置</span>
                  <span class="transform-value" data-transform-value="offsetY">${formatOffsetValue(logoTransform.offsetY)}</span>
                </div>
                <input type="range" min="${IMAGE_OFFSET_MIN}" max="${IMAGE_OFFSET_MAX}" step="1" value="${logoTransform.offsetY}" data-logo-transform="offsetY" ${branding.logoImage ? '' : 'disabled'} />
              </div>
            </div>
            <p class="admin-hint">拖动滑块可在预览中微调 PNG Logo 的大小与位置。</p>
            <p class="admin-hint">若同时设置 Logo 文本与图片，将优先展示图片。上传透明底 PNG 可在深色背景下保持干净效果。</p>
            <button class="button" type="submit">保存站点标识</button>
          </form>
        </div>
        <div class="admin-card">
          <h3>主页文案</h3>
          <form class="inline-form" id="admin-copy-form">
            <h4>首页英雄区</h4>
            <label for="copy-hero-pill">顶部标签</label>
            <input id="copy-hero-pill" type="text" name="heroPill" placeholder="例如：模块化木结构｜可持续建筑" />
            <label for="copy-hero-title">主标题</label>
            <input id="copy-hero-title" type="text" name="heroTitle" placeholder="请输入首页主标题" />
            <label for="copy-hero-intro">介绍段落</label>
            <textarea id="copy-hero-intro" name="heroIntro" rows="3" placeholder="用于说明品牌定位与服务"></textarea>
            <label for="copy-hero-since">年份 / 里程碑</label>
            <input id="copy-hero-since" type="text" name="heroSince" placeholder="例如：2009-2024" />
            <label for="copy-hero-signature">标签说明</label>
            <input id="copy-hero-signature" type="text" name="heroSignature" placeholder="例如：EraWood 设计与制造" />
            <h4>作品列表</h4>
            <label for="copy-works-title">区块标题</label>
            <input id="copy-works-title" type="text" name="worksTitle" placeholder="例如：模块化建筑作品精选" />
            <label for="copy-works-description">区块说明</label>
            <textarea id="copy-works-description" name="worksDescription" rows="3" placeholder="用于介绍作品内容与亮点"></textarea>
            <h4>联系方式区块</h4>
            <label for="copy-contact-title">区块标题</label>
            <input id="copy-contact-title" type="text" name="contactTitle" placeholder="例如：联系我们" />
            <label for="copy-contact-description">区块说明</label>
            <textarea id="copy-contact-description" name="contactDescription" rows="3" placeholder="用于说明联系服务范围"></textarea>
            <h4>登录说明</h4>
            <label for="copy-admin-title">区块标题</label>
            <input id="copy-admin-title" type="text" name="adminTitle" placeholder="例如：登录" />
            <label for="copy-admin-description">区块说明</label>
            <textarea id="copy-admin-description" name="adminDescription" rows="3" placeholder="提示登录与数据存储方式"></textarea>
            <h4>页脚标语</h4>
            <label for="copy-footer-tagline">标语内容</label>
            <input id="copy-footer-tagline" type="text" name="footerTagline" placeholder="例如：以模块化建构自然栖居" />
            <button class="button" type="submit">保存主页文案</button>
          </form>
        </div>
        <div class="admin-card">
          <h3>联系方式</h3>
          <form class="inline-form" id="admin-contact-form">
            <label for="contact-phone">联系电话</label>
            <input id="contact-phone" type="text" name="phone" placeholder="例如：+86 21 8888 6688" />
            <label for="contact-email">联系邮箱</label>
            <input id="contact-email" type="email" name="email" placeholder="例如：hello@example.com" />
            <label for="contact-address">联系地址</label>
            <input id="contact-address" type="text" name="address" placeholder="填写办公地点或展厅地址" />
            <label for="contact-wechat">微信号</label>
            <input id="contact-wechat" type="text" name="wechat" placeholder="例如：EraWood_Studio" />
            <label for="contact-note-input">补充说明</label>
            <textarea id="contact-note-input" name="note" rows="3" placeholder="用于说明合作方式、服务时间等"></textarea>
            <button class="button" type="submit">保存联系方式</button>
          </form>
        </div>
        <div class="admin-card">
          <h3>数据备份与迁移</h3>
          <p class="admin-hint">导出 JSON 文件以备份当前内容，或在其他设备导入以恢复完整的分类、作品与图片数据。</p>
          <div class="data-actions">
            <button class="button" type="button" id="export-data">导出 JSON</button>
            <button class="button secondary" type="button" id="import-data">导入 JSON</button>
            <button class="button secondary" type="button" id="clear-caches-button">清除缓存并重载</button>
            <input type="file" id="import-file" accept="application/json" hidden />
          </div>
          <p class="admin-hint">导入操作会覆盖当前所有数据，请在继续前确认已完成备份。</p>
        </div>
        <div class="admin-card">
          <h3>分类管理</h3>
          <div class="category-list" id="admin-category-list"></div>
          <form class="inline-form" id="admin-add-category">
            <label for="new-category-name">新增分类</label>
            <input id="new-category-name" name="name" type="text" placeholder="例如：户外展厅" required />
            <button class="button" type="submit">添加分类</button>
          </form>
        </div>
        <div class="admin-card">
          <h3>作品管理</h3>
          <label for="admin-work-category">选择分类</label>
          <select id="admin-work-category"></select>
          <div class="work-list" id="admin-work-list"></div>
          <form class="inline-form" id="admin-add-work">
            <h4>新增作品</h4>
            <input type="text" name="name" placeholder="作品名称" required />
            <textarea name="description" placeholder="项目描述" required></textarea>
            <div class="work-meta-grid">
              <input type="text" name="location" placeholder="项目地点" />
              <input type="text" name="area" placeholder="建筑面积" />
              <input type="text" name="year" placeholder="完成年份" />
              <input type="text" name="interiorArea" placeholder="套内面积" />
              <input type="text" name="footprint" placeholder="占地面积" />
              <input type="text" name="productSize" placeholder="产品尺寸" />
              <input type="text" name="roomType" placeholder="房间类型" />
            </div>
            <button class="button" type="submit">创建作品</button>
          </form>
        </div>
      `;

      shell.appendChild(wrapper);

      document.getElementById('logout-button').addEventListener('click', () => {
        state.isAuthenticated = false;
        saveAuthState(false);
        renderAdminShell();
      });

      renderAdminCategories();
      renderAdminWorks();
      setupAdminForms();
      setupDataTools();
      renderBranding();
    }

    function renderAdminCategories() {
      const list = document.getElementById('admin-category-list');
      if (!list) return;
      const adminUI = ensureAdminUI();
      list.innerHTML = '';

      if (!state.data.categories.length) {
        const empty = document.createElement('p');
        empty.textContent = '暂无分类，请添加新的作品系列。';
        empty.className = 'gallery-empty';
        list.appendChild(empty);
        adminUI.selectedCategory = '';
        adminUI.workDetailsOpen = {};
        adminUI.workListScroll = 0;
        adminUI.focusWorkId = '';
        return;
      }

      state.data.categories.forEach((category, index) => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.innerHTML = `
          <div class="category-header">
            <strong>${category.name}</strong>
            <div class="tag">共 ${category.works.length} 个作品</div>
          </div>
          <div class="inline-form">
            <label>分类名称</label>
            <input type="text" value="${category.name}" data-field="name" />
            <label>分类描述</label>
            <textarea data-field="description">${category.description || ''}</textarea>
            <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
              <button class="button" data-action="save" data-id="${category.id}">保存</button>
              <button class="button secondary" data-action="move-up" data-id="${category.id}" ${index === 0 ? 'disabled' : ''}>上移</button>
              <button class="button secondary" data-action="move-down" data-id="${category.id}" ${index === state.data.categories.length - 1 ? 'disabled' : ''}>下移</button>
              <button class="button secondary" data-action="delete" data-id="${category.id}" ${category.works.length ? 'disabled' : ''}>删除</button>
            </div>
          </div>
        `;

        item.addEventListener('click', (event) => {
          const target = event.target.closest('button');
          if (!target) return;
          const action = target.dataset.action;
          const id = target.dataset.id;
          const categoryIndex = state.data.categories.findIndex((cat) => cat.id === id);
          if (categoryIndex === -1) return;
          const categoryRef = state.data.categories[categoryIndex];

          if (action === 'save') {
            const inputs = item.querySelectorAll('[data-field]');
            inputs.forEach((input) => {
              const field = input.dataset.field;
              categoryRef[field] = input.value.trim();
            });
            saveData(state.data);
            item.querySelector('strong').textContent = categoryRef.name;
            renderFilters();
            renderGallery();
            renderHero();
            renderAdminWorks();
            alert('分类已更新。');
            return;
          }

          if (action === 'delete') {
            if (confirm('确定删除该分类？此操作不可撤销。')) {
              state.data.categories.splice(categoryIndex, 1);
              saveData(state.data);
              if (adminUI.selectedCategory === id) {
                const fallback =
                  state.data.categories[categoryIndex] ||
                  state.data.categories[categoryIndex - 1] ||
                  state.data.categories[0];
                adminUI.selectedCategory = fallback ? fallback.id : '';
                adminUI.workDetailsOpen = {};
                adminUI.workListScroll = 0;
              }
              renderAdminCategories();
              renderAdminWorks();
              renderFilters();
              renderGallery();
              renderHero();
              alert('分类已删除。');
            }
            return;
          }

          if (action === 'move-up' || action === 'move-down') {
            const offset = action === 'move-up' ? -1 : 1;
            const newIndex = categoryIndex + offset;
            if (newIndex >= 0 && newIndex < state.data.categories.length) {
              const [moved] = state.data.categories.splice(categoryIndex, 1);
              state.data.categories.splice(newIndex, 0, moved);
              saveData(state.data);
              renderAdminCategories();
              renderAdminWorks();
              renderFilters();
              renderGallery();
              renderHero();
            }
            return;
          }
      });

      list.appendChild(item);
    });
  }

    function updateTransformIndicators(container, transform) {
      if (!container) return;
      const sanitized = ensureImageTransform(transform);
      const scaleEl = container.querySelector('[data-transform-value="scale"]');
      if (scaleEl) {
        scaleEl.textContent = formatScaleValue(sanitized.scale);
      }
      const offsetXEl = container.querySelector('[data-transform-value="offsetX"]');
      if (offsetXEl) {
        offsetXEl.textContent = formatOffsetValue(sanitized.offsetX);
      }
      const offsetYEl = container.querySelector('[data-transform-value="offsetY"]');
      if (offsetYEl) {
        offsetYEl.textContent = formatOffsetValue(sanitized.offsetY);
      }
    }

    function renderImageItem(work, image, imageIndex, totalImages) {
      const sanitized = ensureImageTransform(image.transform);
      image.transform = sanitized;
      const transformStyle = buildImageTransform(sanitized);
      const isCover = work.coverId === image.id;
      return `
        <div class="image-item" data-image-id="${image.id}">
          <div class="image-thumb">
            <div class="image-preview-frame">
              <img src="${image.src}" alt="${image.alt}" style="transform: ${transformStyle}" />
            </div>
            <div>
              <label>图片描述</label>
              <input type="text" value="${image.alt}" data-image-field="alt" />
            </div>
          </div>
          <div class="image-actions">
            <button class="button secondary" data-action="cover" data-image-id="${image.id}" ${isCover ? 'disabled' : ''}>设为封面</button>
            <button class="button secondary" data-action="move-image-up" data-image-id="${image.id}" ${imageIndex === 0 ? 'disabled' : ''}>上移</button>
            <button class="button secondary" data-action="move-image-down" data-image-id="${image.id}" ${imageIndex === totalImages - 1 ? 'disabled' : ''}>下移</button>
            <button class="button secondary" data-action="delete-image" data-image-id="${image.id}">删除</button>
          </div>
          <div class="image-transform">
            <div class="transform-control">
              <div class="transform-label">
                <span>缩放</span>
                <span class="transform-value" data-transform-value="scale">${formatScaleValue(sanitized.scale)}</span>
              </div>
              <input type="range" min="${IMAGE_SCALE_MIN}" max="${IMAGE_SCALE_MAX}" step="0.01" value="${sanitized.scale}" data-image-transform="scale" />
            </div>
            <div class="transform-control">
              <div class="transform-label">
                <span>水平位置</span>
                <span class="transform-value" data-transform-value="offsetX">${formatOffsetValue(sanitized.offsetX)}</span>
              </div>
              <input type="range" min="${IMAGE_OFFSET_MIN}" max="${IMAGE_OFFSET_MAX}" step="1" value="${sanitized.offsetX}" data-image-transform="offsetX" />
            </div>
            <div class="transform-control">
              <div class="transform-label">
                <span>垂直位置</span>
                <span class="transform-value" data-transform-value="offsetY">${formatOffsetValue(sanitized.offsetY)}</span>
              </div>
              <input type="range" min="${IMAGE_OFFSET_MIN}" max="${IMAGE_OFFSET_MAX}" step="1" value="${sanitized.offsetY}" data-image-transform="offsetY" />
            </div>
            <div class="transform-actions">
              <button class="button secondary" data-action="reset-transform" data-image-id="${image.id}" ${isDefaultTransform(sanitized) ? 'disabled' : ''}>重置视图</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderAdminWorks() {
      const select = document.getElementById('admin-work-category');
      const list = document.getElementById('admin-work-list');
      if (!select || !list) return;

      const adminUI = ensureAdminUI();
      const previousScroll = typeof adminUI.workListScroll === 'number' ? adminUI.workListScroll : list.scrollTop || 0;
      const openMap = { ...adminUI.workDetailsOpen };

      if (!list.dataset.scrollBound) {
        list.addEventListener('scroll', () => {
          const ui = ensureAdminUI();
          ui.workListScroll = list.scrollTop;
        });
        list.dataset.scrollBound = 'true';
      }

      select.innerHTML = '';

      if (!state.data.categories.length) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '请先创建分类';
        select.appendChild(option);
        list.innerHTML = '<p class="gallery-empty">暂无作品，请添加分类后再新增作品。</p>';
        adminUI.selectedCategory = '';
        adminUI.workDetailsOpen = {};
        adminUI.workListScroll = 0;
        return;
      }

      state.data.categories.forEach((category) => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = `${category.name}（${category.works.length}）`;
        select.appendChild(option);
      });

      if (adminUI.selectedCategory && !state.data.categories.some((cat) => cat.id === adminUI.selectedCategory)) {
        adminUI.selectedCategory = '';
      }

      if (!adminUI.selectedCategory) {
        adminUI.selectedCategory = state.data.categories[0].id;
      }

      select.value = adminUI.selectedCategory;
      adminUI.selectedCategory = select.value;
      const currentCategory = findCategory(select.value);
      list.innerHTML = '';
      adminUI.workDetailsOpen = {};

      if (!currentCategory || !currentCategory.works.length) {
        list.innerHTML = '<p class="gallery-empty">该分类暂未添加作品。</p>';
        adminUI.workListScroll = 0;
        adminUI.focusWorkId = '';
        list.scrollTop = 0;
        return;
      }

      currentCategory.works.forEach((work, index) => {
        const item = document.createElement('div');
        item.className = 'work-item';
        item.dataset.workId = work.id;
        item.dataset.categoryId = currentCategory.id;
        item.innerHTML = `
          <div class="work-header">
            <strong>${work.name}</strong>
            <div class="tag">图集 ${work.images.length} 张</div>
          </div>
          <div class="inline-form">
            <label>作品名称</label>
            <input type="text" data-field="name" value="${work.name}" />
            <label>项目描述</label>
            <textarea data-field="description">${work.description || ''}</textarea>
            <div class="work-meta-grid">
              <div>
                <label>项目地点</label>
                <input type="text" data-field="location" value="${work.location || ''}" />
              </div>
              <div>
                <label>建筑面积</label>
                <input type="text" data-field="area" value="${work.area || ''}" />
              </div>
              <div>
                <label>完成年份</label>
                <input type="text" data-field="year" value="${work.year || ''}" />
              </div>
              <div>
                <label>套内面积</label>
                <input type="text" data-field="interiorArea" value="${work.interiorArea || ''}" />
              </div>
              <div>
                <label>占地面积</label>
                <input type="text" data-field="footprint" value="${work.footprint || ''}" />
              </div>
              <div>
                <label>产品尺寸</label>
                <input type="text" data-field="productSize" value="${work.productSize || ''}" />
              </div>
              <div>
                <label>房间类型</label>
                <input type="text" data-field="roomType" value="${work.roomType || ''}" />
              </div>
            </div>
            <details>
              <summary>图集管理</summary>
              <div class="image-list">
                ${work.images
                  .map((image, imageIndex, list) => renderImageItem(work, image, imageIndex, list.length))
                  .join('')}
                <label>新增图片（支持多选）</label>
                <input type="file" accept="image/*" multiple data-action="upload-images" data-work-id="${work.id}" />
              </div>
            </details>
            <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
              <button class="button" data-action="save-work" data-work-id="${work.id}">保存作品</button>
              <button class="button secondary" data-action="move-work-up" data-work-id="${work.id}" ${index === 0 ? 'disabled' : ''}>上移</button>
              <button class="button secondary" data-action="move-work-down" data-work-id="${work.id}" ${index === currentCategory.works.length - 1 ? 'disabled' : ''}>下移</button>
              <button class="button secondary" data-action="delete-work" data-work-id="${work.id}">删除</button>
            </div>
          </div>
        `;

        const details = item.querySelector('details');
        if (details) {
          if (openMap[work.id]) {
            details.setAttribute('open', '');
          }
          if (details.open) {
            adminUI.workDetailsOpen[work.id] = true;
          }
          details.addEventListener('toggle', () => {
            const ui = ensureAdminUI();
            if (details.open) {
              ui.workDetailsOpen[work.id] = true;
            } else {
              delete ui.workDetailsOpen[work.id];
            }
          });
        }

        item.addEventListener('click', (event) => {
          const target = event.target.closest('button');
          if (!target) return;
          const action = target.dataset.action;
          const workId = target.dataset.workId || work.id;
          const categoryId = currentCategory.id;
          handleWorkAction(action, categoryId, workId, target.dataset.imageId);
        });

        item.querySelectorAll('[data-image-field]').forEach((input) => {
          input.addEventListener('change', () => {
            const imageId = input.closest('[data-image-id]').dataset.imageId;
            const image = work.images.find((img) => img.id === imageId);
            if (image) {
              image.alt = input.value.trim();
              saveData(state.data);
              renderGallery();
            }
          });
        });

        item.querySelectorAll('[data-image-transform]').forEach((input) => {
          input.addEventListener('input', () => {
            const imageId = input.closest('[data-image-id]').dataset.imageId;
            const image = work.images.find((img) => img.id === imageId);
            if (!image) return;
            if (!image.transform) {
              image.transform = defaultImageTransform();
            }
            const key = input.dataset.imageTransform;
            const numericValue = Number.parseFloat(input.value);
            if (key === 'scale') {
              const value = Number.isFinite(numericValue) ? numericValue : image.transform.scale;
              image.transform.scale = clamp(value, IMAGE_SCALE_MIN, IMAGE_SCALE_MAX);
            }
            if (key === 'offsetX') {
              const value = Number.isFinite(numericValue) ? numericValue : image.transform.offsetX;
              image.transform.offsetX = clamp(value, IMAGE_OFFSET_MIN, IMAGE_OFFSET_MAX);
            }
            if (key === 'offsetY') {
              const value = Number.isFinite(numericValue) ? numericValue : image.transform.offsetY;
              image.transform.offsetY = clamp(value, IMAGE_OFFSET_MIN, IMAGE_OFFSET_MAX);
            }
            saveData(state.data);
            const container = input.closest('.image-item');
            updateTransformIndicators(container, image.transform);
            const previewImg = container?.querySelector('.image-thumb img');
            applyImageTransform(previewImg, image.transform);
            const resetButton = container?.querySelector('[data-action="reset-transform"]');
            if (resetButton) {
              resetButton.disabled = isDefaultTransform(image.transform);
            }
            renderGallery();
            updateLightbox();
          });
        });

            item.querySelectorAll('[data-action="upload-images"]').forEach((input) => {
          input.addEventListener('change', (event) => {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;
            const ui = ensureAdminUI();
            ui.workDetailsOpen[work.id] = true;
            ui.focusWorkId = work.id;
            ui.workListScroll = list.scrollTop;

            // 新行为：不将图片读成 data URI，而是记录文件名（假定你会把这些文件放在与 index.html 相同的目录）
            try {
              const images = files.map((file) => ({
                id: uid(`${work.id}-img`),
                src: file.name,
                alt: file.name.replace(/\.[^.]+$/, '') || work.name,
                transform: defaultImageTransform(),
                originalName: file.name || ''
              }));

              work.images.push(...images);
              if (!work.coverId && work.images.length) {
                work.coverId = work.images[0].id;
              }
              saveData(state.data);
              renderAdminWorks();
              renderGallery();
              alert('已记录图片文件名（未嵌入）。请确保相应图片文件已上传到站点目录。');
            } catch (e) {
              console.warn('处理上传文件时出错', e);
              alert('处理上传文件时出错，请重试。');
            } finally {
              event.target.value = '';
            }
          });
        });

        list.appendChild(item);
      });

      list.scrollTop = previousScroll;
      if (adminUI.focusWorkId) {
        const focusEl = list.querySelector(`[data-work-id="${adminUI.focusWorkId}"]`);
        if (focusEl) {
          focusEl.scrollIntoView({ block: 'nearest' });
          adminUI.workListScroll = list.scrollTop;
        }
      } else {
        adminUI.workListScroll = list.scrollTop;
      }
      adminUI.focusWorkId = '';

      if (!select.dataset.bound) {
        select.addEventListener('change', (event) => {
          const ui = ensureAdminUI();
          ui.selectedCategory = event.target.value;
          ui.workDetailsOpen = {};
          ui.workListScroll = 0;
          ui.focusWorkId = '';
          renderAdminWorks();
        });
        select.dataset.bound = 'true';
      }
    }

    function handleWorkAction(action, categoryId, workId, imageId) {
      const category = findCategory(categoryId);
      if (!category) return;
      const workIndex = category.works.findIndex((item) => item.id === workId);
      if (workIndex === -1) return;
      const work = category.works[workIndex];
      const adminUI = ensureAdminUI();
      const list = document.getElementById('admin-work-list');
      if (list) {
        adminUI.workListScroll = list.scrollTop;
      }

      if (action === 'delete-work') {
        if (confirm('确认删除该作品？')) {
          category.works.splice(workIndex, 1);
          delete adminUI.workDetailsOpen[workId];
          const fallback = category.works[workIndex] || category.works[workIndex - 1];
          if (fallback) {
            adminUI.focusWorkId = fallback.id;
            adminUI.workDetailsOpen[fallback.id] = true;
          } else {
            adminUI.focusWorkId = '';
          }
          saveData(state.data);
          renderAdminCategories();
          renderAdminWorks();
          renderGallery();
          renderHero();
        }
        return;
      }

      if (action === 'move-work-up' || action === 'move-work-down') {
        const offset = action === 'move-work-up' ? -1 : 1;
        const newIndex = workIndex + offset;
        if (newIndex >= 0 && newIndex < category.works.length) {
          category.works.splice(workIndex, 1);
          category.works.splice(newIndex, 0, work);
          adminUI.focusWorkId = work.id;
          adminUI.workDetailsOpen[work.id] = true;
          saveData(state.data);
          renderAdminWorks();
          renderGallery();
          renderHero();
        }
        return;
      }

      if (action === 'save-work') {
        const container = document.querySelector(`.work-item[data-work-id="${workId}"]`);
        if (!container) {
          renderAdminWorks();
          return;
        }
        container.querySelectorAll('[data-field]').forEach((input) => {
          const field = input.dataset.field;
          work[field] = input.value.trim();
        });
        saveData(state.data);
        renderGallery();
        alert('作品信息已保存。');
        return;
      }

      if (!imageId) return;
      const imageIndex = work.images.findIndex((image) => image.id === imageId);
      if (imageIndex === -1) return;
      const image = work.images[imageIndex];

      if (action === 'reset-transform') {
        image.transform = defaultImageTransform();
        adminUI.focusWorkId = work.id;
        adminUI.workDetailsOpen[work.id] = true;
        saveData(state.data);
        renderAdminWorks();
        renderGallery();
        updateLightbox();
        return;
      }

      if (action === 'delete-image') {
        if (confirm('删除该图片？')) {
          work.images.splice(imageIndex, 1);
          if (work.coverId === imageId) {
            work.coverId = work.images[0]?.id || null;
          }
          adminUI.focusWorkId = work.id;
          adminUI.workDetailsOpen[work.id] = true;
          saveData(state.data);
          renderAdminWorks();
          renderGallery();
        }
        return;
      }

      if (action === 'move-image-up' || action === 'move-image-down') {
        const offset = action === 'move-image-up' ? -1 : 1;
        const newIndex = imageIndex + offset;
        if (newIndex >= 0 && newIndex < work.images.length) {
          work.images.splice(imageIndex, 1);
          work.images.splice(newIndex, 0, image);
          adminUI.focusWorkId = work.id;
          adminUI.workDetailsOpen[work.id] = true;
          saveData(state.data);
          renderAdminWorks();
          renderGallery();
        }
        return;
      }

      if (action === 'cover') {
        work.coverId = image.id;
        adminUI.focusWorkId = work.id;
        adminUI.workDetailsOpen[work.id] = true;
        saveData(state.data);
        renderAdminWorks();
        renderGallery();
        return;
      }
    }

    function populateAdminCopyForm() {
      const form = document.getElementById('admin-copy-form');
      if (!form) return;
      const hero = ensureHero(state.data.hero);
      const sections = ensureSections(state.data.sections);

      const setValue = (name, value) => {
        const control = form.elements.namedItem(name);
        if (control && 'value' in control) {
          control.value = value || '';
        }
      };

      setValue('heroPill', hero.pill);
      setValue('heroTitle', hero.title);
      setValue('heroIntro', hero.intro);
      setValue('heroSince', hero.since);
      setValue('heroSignature', hero.signature);
      setValue('worksTitle', sections.works.title);
      setValue('worksDescription', sections.works.description);
      setValue('contactTitle', sections.contact.title);
      setValue('contactDescription', sections.contact.description);
      setValue('adminTitle', sections.admin.title);
      setValue('adminDescription', sections.admin.description);
      setValue('footerTagline', sections.footer.tagline);
    }

    function populateAdminContactForm() {
      const form = document.getElementById('admin-contact-form');
      if (!form) return;
      const contact = ensureContact(state.data.contact);

      const setValue = (name, value) => {
        const control = form.elements.namedItem(name);
        if (control && 'value' in control) {
          control.value = value || '';
        }
      };

      setValue('phone', contact.phone);
      setValue('email', contact.email);
      setValue('address', contact.address);
      setValue('wechat', contact.wechat);
      setValue('note', contact.note);
    }

    function setupAdminForms() {
      const categoryForm = document.getElementById('admin-add-category');
      const workForm = document.getElementById('admin-add-work');
      const categorySelect = document.getElementById('admin-work-category');
      const brandingForm = document.getElementById('admin-branding-form');
      const brandingUploadButton = document.getElementById('branding-upload-button');
      const brandingFileInput = document.getElementById('branding-logo-file');
      const brandingClearButton = document.getElementById('branding-clear-logo');
      const brandingTransformInputs = brandingForm?.querySelectorAll('[data-logo-transform]') || [];
      const logoUploadTarget = document.getElementById('admin-logo-upload');
      const copyForm = document.getElementById('admin-copy-form');
      const contactForm = document.getElementById('admin-contact-form');

      const triggerBrandingUpload = () => {
        if (brandingFileInput) {
          brandingFileInput.click();
        }
      };

      if (brandingForm) {
        brandingForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(brandingForm);
          const companyName = (formData.get('companyName') || '').toString().trim();
          const logoText = (formData.get('logoText') || '').toString().trim();
          const companyIntro = (formData.get('companyIntro') || '').toString().trim();
          const current = ensureBranding(state.data.branding);
          state.data.branding = ensureBranding({
            companyName,
            logoText,
            logoImage: current.logoImage,
            companyIntro,
            logoTransform: current.logoTransform
          });
          saveData(state.data);
          renderBranding();
          renderGallery();
          alert('站点标识已更新。');
        });
      }

      if (brandingUploadButton && brandingFileInput) {
        brandingUploadButton.addEventListener('click', (event) => {
          event.preventDefault();
          triggerBrandingUpload();
        });

        brandingFileInput.addEventListener('change', (event) => {
          const [file] = event.target.files || [];
          if (!file) return;
          if (!file.type.startsWith('image/')) {
            alert('请选择图片格式的文件。');
            brandingFileInput.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = (loadEvent) => {
            state.data.branding.logoImage = loadEvent.target.result;
            state.data.branding.logoTransform = defaultImageTransform();
            saveData(state.data);
            renderBranding();
            renderGallery();
            alert('Logo 图片已更新。');
            brandingFileInput.value = '';
          };
          reader.onerror = () => {
            alert('读取图片失败，请重试。');
            brandingFileInput.value = '';
          };
          reader.readAsDataURL(file);
        });
      }

      if (logoUploadTarget && brandingFileInput) {
        const handleLogoTrigger = (event) => {
          if (event.type === 'keydown') {
            if (event.key !== 'Enter' && event.key !== ' ') {
              return;
            }
            event.preventDefault();
            triggerBrandingUpload();
            return;
          }
          if (event.type === 'click' && event.target !== brandingFileInput) {
            triggerBrandingUpload();
          }
        };
        logoUploadTarget.addEventListener('click', handleLogoTrigger);
        logoUploadTarget.addEventListener('keydown', handleLogoTrigger);
      }

      if (brandingClearButton) {
        brandingClearButton.addEventListener('click', () => {
          if (!state.data.branding?.logoImage) return;
          const confirmed = confirm('确定移除当前 Logo 图片？');
          if (!confirmed) return;
          state.data.branding.logoImage = '';
          state.data.branding.logoTransform = defaultImageTransform();
          saveData(state.data);
          renderBranding();
          renderGallery();
          alert('Logo 图片已移除。');
        });
      }

      brandingTransformInputs.forEach((input) => {
        input.addEventListener('input', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLInputElement)) return;
          const field = target.dataset.logoTransform;
          if (!field) return;
          const branding = ensureBranding(state.data.branding);
          if (!branding.logoImage) {
            renderBranding();
            return;
          }
          const next = { ...branding.logoTransform };
          const value = Number.parseFloat(target.value);
          if (field === 'scale') {
            next.scale = clamp(Number.isFinite(value) ? value : next.scale, IMAGE_SCALE_MIN, IMAGE_SCALE_MAX);
            target.value = next.scale;
          } else if (field === 'offsetX') {
            next.offsetX = clamp(Number.isFinite(value) ? value : next.offsetX, IMAGE_OFFSET_MIN, IMAGE_OFFSET_MAX);
            target.value = next.offsetX;
          } else if (field === 'offsetY') {
            next.offsetY = clamp(Number.isFinite(value) ? value : next.offsetY, IMAGE_OFFSET_MIN, IMAGE_OFFSET_MAX);
            target.value = next.offsetY;
          }
          state.data.branding = ensureBranding({ ...branding, logoTransform: next });
          saveData(state.data);
          renderBranding();
        });
      });

      if (copyForm) {
        copyForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(copyForm);
          const text = (name) => (formData.get(name) || '').toString().trim();
          const hero = ensureHero({
            pill: text('heroPill'),
            title: text('heroTitle'),
            intro: text('heroIntro'),
            since: text('heroSince'),
            signature: text('heroSignature')
          });
          const sections = ensureSections({
            works: {
              title: text('worksTitle'),
              description: text('worksDescription')
            },
            contact: {
              title: text('contactTitle'),
              description: text('contactDescription')
            },
            admin: {
              title: text('adminTitle'),
              description: text('adminDescription')
            },
            footer: {
              tagline: text('footerTagline')
            }
          });
          state.data.hero = hero;
          state.data.sections = sections;
          saveData(state.data);
          renderHero();
          renderSectionsText();
          populateAdminCopyForm();
          alert('主页文案已更新。');
        });
      }

      if (contactForm) {
        contactForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(contactForm);
          const text = (name) => (formData.get(name) || '').toString().trim();
          state.data.contact = ensureContact({
            phone: text('phone'),
            email: text('email'),
            address: text('address'),
            wechat: text('wechat'),
            note: text('note')
          });
          saveData(state.data);
          renderContact();
          populateAdminContactForm();
          alert('联系方式已更新。');
        });
      }

      populateAdminCopyForm();
      populateAdminContactForm();

      if (categoryForm) {
        categoryForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const name = categoryForm.name.value.trim();
          if (!name) return;
          const id = uid('cat');
          state.data.categories.push({ id, name, description: '', works: [] });
          saveData(state.data);
          categoryForm.reset();
          const adminUI = ensureAdminUI();
          adminUI.selectedCategory = id;
          adminUI.workDetailsOpen = {};
          adminUI.workListScroll = 0;
          adminUI.focusWorkId = '';
          renderAdminCategories();
          renderAdminWorks();
          renderFilters();
          renderGallery();
          renderHero();
        });
      }

      if (workForm) {
        workForm.addEventListener('submit', (event) => {
          event.preventDefault();
          if (!categorySelect?.value) {
            alert('请先选择分类。');
            return;
          }
          const formData = new FormData(workForm);
          const name = formData.get('name').trim();
          if (!name) return;
          const work = {
            id: uid('work'),
            name,
            description: formData.get('description').trim(),
            location: formData.get('location').trim(),
            area: formData.get('area').trim(),
            year: formData.get('year').trim(),
            interiorArea: (formData.get('interiorArea') || '').toString().trim(),
            footprint: (formData.get('footprint') || '').toString().trim(),
            productSize: (formData.get('productSize') || '').toString().trim(),
            roomType: (formData.get('roomType') || '').toString().trim(),
            coverId: null,
            images: []
          };
          const category = findCategory(categorySelect.value);
          category.works.push(work);
          saveData(state.data);
          workForm.reset();
          const adminUI = ensureAdminUI();
          adminUI.selectedCategory = category.id;
          adminUI.workDetailsOpen[work.id] = true;
          adminUI.focusWorkId = work.id;
          adminUI.workListScroll = document.getElementById('admin-work-list')?.scrollTop || 0;
          renderAdminCategories();
          renderAdminWorks();
          renderGallery();
          renderHero();
          alert('作品已创建，请上传图片。');
        });
      }
    }

    function setupDataTools() {
      const exportButton = document.getElementById('export-data');
      const importButton = document.getElementById('import-data');
      const importInput = document.getElementById('import-file');

      if (exportButton) {
        exportButton.addEventListener('click', () => {
          exportPortfolioData();
        });
      }

      if (importButton && importInput) {
        importButton.addEventListener('click', () => {
          importInput.click();
        });

        importInput.addEventListener('change', (event) => {
          const [file] = event.target.files || [];
          if (!file) return;
          if (!file.type.includes('json') && !file.name.toLowerCase().endsWith('.json')) {
            alert('请选择 JSON 格式的文件。');
            importInput.value = '';
            return;
          }
          const confirmed = confirm('导入 JSON 后将覆盖当前所有数据，确定要继续吗？');
          if (!confirmed) {
            importInput.value = '';
            return;
          }
          importPortfolioData(file, importInput);
        });
      }

      const clearCachesButton = document.getElementById('clear-caches-button');
      if (clearCachesButton) {
        clearCachesButton.addEventListener('click', async () => {
          const ok = confirm('确定要清除浏览器缓存并强制重载页面吗？此操作会清除 localStorage、CacheStorage 及注销 service worker。');
          if (!ok) return;
          try {
            await window.clearAllCaches();
          } catch (e) {
            console.warn('清除缓存失败，尝试手动刷新。', e);
            window.location.reload(true);
          }
        });
      }
    }

    function exportPortfolioData() {
      try {
        // 深拷贝数据，避免修改页面当前 state
        const exportData = JSON.parse(JSON.stringify(state.data || {}));

        // 将任何 data: URI 或本地嵌入的图片引用替换为相对于 index.html 的文件名（仅在 src 为 data: URI 时生成）
        // 并把这些生成的文件名写回到 state.data 中以保持后续导出一致性
        const generatedMappings = [];
        const takenNames = new Set();
        (exportData.categories || []).forEach((cat) => {
          (cat.works || []).forEach((work) => {
            (work.images || []).forEach((img) => {
              try {
                const src = (img.src || '').toString();
                if (!src) return;
                // 远程绝对 URL 保持不变
                if (/^https?:\/\//i.test(src)) return;

                if (src.startsWith('data:')) {
                  const commaIndex = src.indexOf(',');
                  const meta = commaIndex > 5 ? src.slice(5, commaIndex) : '';
                  let mime = meta.split(';')[0] || '';
                  let ext = 'bin';
                  if (/svg/i.test(mime) || /svg\+xml/i.test(mime)) ext = 'svg';
                  else if (/png/i.test(mime)) ext = 'png';
                  else if (/jpeg/i.test(mime) || /jpg/i.test(mime)) ext = 'jpg';
                  else if (/webp/i.test(mime)) ext = 'webp';
                  else if (/gif/i.test(mime)) ext = 'gif';

                  // 优先使用上传时保存的 originalName（去除扩展并 sanitize），否则退回到 id
                  let baseName = '';
                  if (img.originalName) {
                    const withoutExt = img.originalName.replace(/\.[^.]+$/, '');
                    baseName = sanitizeFilename(withoutExt) || '';
                  }
                  if (!baseName) baseName = img.id || uid('img');

                  // 生成不重复的文件名
                  let candidate = `${baseName}.${ext}`;
                  let counter = 1;
                  while (takenNames.has(candidate)) {
                    candidate = `${baseName}-${counter}.${ext}`;
                    counter += 1;
                  }
                  takenNames.add(candidate);

                  img.src = candidate;
                  generatedMappings.push({ id: img.id, filename: candidate });
                }
              } catch (e) {
                console.warn('处理图片引用时出错，保留原始 src。', e);
              }
            });
          });
        });

        // 将生成的文件名同步回真实运行时 state，避免下次导出再次生成不同的 id 名称
        if (generatedMappings.length) {
          generatedMappings.forEach((m) => {
            (state.data.categories || []).forEach((cat) => {
              (cat.works || []).forEach((work) => {
                (work.images || []).forEach((img) => {
                  if (img.id === m.id && img.src && img.src.startsWith('data:')) {
                    img.src = m.filename;
                  }
                });
              });
            });
          });
          try {
            saveData(state.data);
          } catch (e) {
            console.warn('导出时将生成的图片文件名写回 state 失败。', e);
          }
        }

        const content = JSON.stringify(exportData, null, 2);
        const blob = new Blob([content], { type: 'application/json' });
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `erawood-portfolio-${timestamp}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('导出 JSON 失败', error);
        alert('导出失败，请重试。');
      }
    }

    function importPortfolioData(file, input) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const parsed = JSON.parse(event.target.result);
          const normalized = normalizeImportedData(parsed);
          state.data = normalized;
          saveData(state.data);
          state.filter = 'all';
          resetAdminUIState();
          state.lightbox = { categoryId: null, workId: null, index: 0 };
          closeLightbox();
          renderHero();
          renderSectionsText();
          renderFilters();
          renderGallery();
          renderBranding();
          renderContact();
          renderAdminShell();
          alert('数据导入成功，当前内容已更新。');
        } catch (error) {
          console.error('导入 JSON 失败', error);
          alert(error?.message ? `导入失败：${error.message}` : '导入失败：JSON 格式不正确。');
        } finally {
          if (input) {
            input.value = '';
          }
        }
      };

      reader.onerror = () => {
        alert('读取文件失败，请重试。');
        if (input) {
          input.value = '';
        }
      };

      reader.readAsText(file, 'utf-8');
    }

    function normalizeImportedData(raw) {
      if (!raw || typeof raw !== 'object') {
        throw new Error('JSON 内容为空或格式不正确。');
      }

      if (!Array.isArray(raw.categories)) {
        throw new Error('缺少分类数据。');
      }

      const normalized = {
        hero: raw.hero && typeof raw.hero === 'object' ? { ...raw.hero } : {},
        sections: raw.sections && typeof raw.sections === 'object' ? { ...raw.sections } : {},
        branding: ensureBranding(raw.branding),
        categories: [],
        contact: raw.contact && typeof raw.contact === 'object' ? { ...raw.contact } : {}
      };

      normalized.categories = raw.categories.map((category, catIndex) => {
        if (!category || typeof category !== 'object') {
          throw new Error(`第 ${catIndex + 1} 个分类格式不正确。`);
        }
        if (!Array.isArray(category.works)) {
          throw new Error(`分类“${category.name || catIndex + 1}”缺少作品列表。`);
        }

        const works = category.works.map((work, workIndex) => {
          if (!work || typeof work !== 'object') {
            throw new Error(`分类“${category.name || catIndex + 1}”中的第 ${workIndex + 1} 个作品格式不正确。`);
          }
          if (!Array.isArray(work.images)) {
            throw new Error(`作品“${work.name || workIndex + 1}”缺少图片列表。`);
          }

          const images = work.images.map((image, imageIndex) => {
            if (!image || typeof image !== 'object' || !image.id || !image.src) {
              throw new Error(`作品“${work.name || workIndex + 1}”的第 ${imageIndex + 1} 张图片缺少必要字段。`);
            }
            return {
              id: image.id,
              alt: image.alt || '',
              src: image.src,
              transform: ensureImageTransform(image.transform)
            };
          });

          return {
            id: work.id || uid('work'),
            name: work.name || `未命名作品 ${workIndex + 1}`,
            description: work.description || '',
            location: work.location || '',
            area: work.area || '',
            year: work.year || '',
            interiorArea: work.interiorArea || '',
            footprint: work.footprint || '',
            productSize: work.productSize || '',
            roomType: work.roomType || '',
            coverId: images.find((img) => img.id === work.coverId)?.id || images[0]?.id || null,
            images
          };
        });

        return {
          id: category.id || uid('cat'),
          name: category.name || `未命名分类 ${catIndex + 1}`,
          description: category.description || '',
          works
        };
      });

      normalized.hero = ensureHero(normalized.hero);
      normalized.sections = ensureSections(normalized.sections);
      normalized.contact = ensureContact(normalized.contact);

      return normalized;
    }

    function bindLightboxControls() {
      document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
      document.getElementById('lightbox').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
          closeLightbox();
        }
      });

      document.getElementById('lightbox-prev').addEventListener('click', () => {
        const { categoryId, workId, index } = state.lightbox;
        if (index > 0) {
          state.lightbox.index -= 1;
          updateLightbox();
        }
      });

      document.getElementById('lightbox-next').addEventListener('click', () => {
        const { categoryId, workId, index } = state.lightbox;
        const work = findWork(categoryId, workId);
        if (work && index < work.images.length - 1) {
          state.lightbox.index += 1;
          updateLightbox();
        }
      });

      document.addEventListener('keydown', (event) => {
        const lightbox = document.getElementById('lightbox');
        if (!lightbox.classList.contains('open')) return;
        if (event.key === 'Escape') {
          closeLightbox();
        }
        if (event.key === 'ArrowLeft') {
          document.getElementById('lightbox-prev').click();
        }
        if (event.key === 'ArrowRight') {
          document.getElementById('lightbox-next').click();
        }
      });
    }

    async function initialize() {
      // 优先尝试从远程预加载 JSON（若存在），失败则使用本地存储或内置默认数据
      await fetchRemoteData().catch(() => {});

      renderBranding();
      renderHero();
      renderSectionsText();
      renderFilters();
      renderGallery();
      renderContact();
      renderAdminShell();
      bindLightboxControls();
      document.getElementById('footer-year').textContent = new Date().getFullYear();
    }

    // 清除浏览器缓存/存储的辅助函数
    async function clearCachesAndStorage() {
      try {
        // Clear CacheStorage
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map((name) => caches.delete(name)));
          console.info('CacheStorage cleared:', cacheNames);
        }
      } catch (e) {
        console.warn('清除 CacheStorage 失败', e);
      }

      try {
        // Unregister service workers
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map((r) => r.unregister()));
          console.info('Service workers unregistered:', regs.length);
        }
      } catch (e) {
        console.warn('注销 Service Worker 失败', e);
      }

      try {
        localStorage.clear();
        sessionStorage.clear();
        console.info('localStorage & sessionStorage cleared');
      } catch (e) {
        console.warn('清除 local/session storage 失败', e);
      }

      try {
        // 尝试删除所有 IndexedDB（可能会提示权限）
        if (window.indexedDB && indexedDB.databases) {
          const dbs = await indexedDB.databases();
          await Promise.all(dbs.map((db) => new Promise((res) => {
            const req = indexedDB.deleteDatabase(db.name);
            req.onsuccess = () => res(true);
            req.onerror = () => res(false);
            req.onblocked = () => res(false);
          })));
          console.info('IndexedDB databases deletion attempted');
        }
      } catch (e) {
        // indexedDB.databases() 不是所有浏览器都支持，忽略错误
        console.warn('尝试删除 IndexedDB 失败或不受支持', e);
      }
    }

    // 暴露手动调用接口
    window.clearAllCaches = async function autoClearAndReload() {
      await clearCachesAndStorage();
      // reload with a cache-busting param
      const url = new URL(window.location.href);
      url.searchParams.set('nocache', Date.now().toString());
      window.location.replace(url.toString());
    };

    // 不在每次加载时自动清除缓存（避免影响远程访客的速度）。
    // 改为：页面加载时直接初始化并尝试从远程预加载 JSON（fetchRemoteData 使用 no-cache），
    // 管理员可以手动通过管理界面的按钮触发清缓存和重载。
    document.addEventListener('DOMContentLoaded', () => {
      initialize().catch((err) => console.error(err));
    });
  </script>
</body>
</html>
